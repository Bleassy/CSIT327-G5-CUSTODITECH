{% extends 'dashboards/admin_base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/order_management.css' %}?v=1.3"> {# Incremented version #}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Order & Reservation Management</h1>
</div>

<div class="page-controls">
    <div class="search-form">
        <input type="search" id="admin-order-search" class="search-input" placeholder="Search by Student Name/ID, Product Name, Category, or Status..." value="{{ search_query }}">
    </div>
</div>

<!-- Form for Batch Status Update (Approved section) -->
<form id="batch-status-form" method="POST" action="{% url 'update_order_status' order_id=0 %}"> {# Dummy URL, will be overridden #}
    {% csrf_token %}
    <input type="hidden" name="order_ids" id="batch-status-order-ids">
    <input type="hidden" name="status" id="batch-status-action">
</form>

<!-- âœ… UPDATED: Form for Batch Deletion (Completed/Other sections) now points to the correct admin URL -->
<form id="batch-delete-form" method="POST" action="{% url 'admin_batch_delete_orders' %}">
    {% csrf_token %}
    <input type="hidden" name="order_ids" id="batch-delete-order-ids">
</form>

<form id="batch-pending-status-form" method="POST" action="{% url 'update_order_status' order_id=0 %}">
    {% csrf_token %}
    <input type="hidden" name="order_ids" id="batch-pending-status-order-ids">
    <input type="hidden" name="status" id="batch-pending-status-action">
</form>


<!-- Approved Orders Section -->
<section class="order-section" data-section-status="approved">
    <h2 class="section-title">Approved Orders</h2>
    {% if approved_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="approved">
        <label>Select All Approved</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in approved_orders %}
<div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            <input type="checkbox" class="order-checkbox approved-checkbox" value="{{ order.id }}">
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Quantity:</span><strong>{{ order.quantity }}</strong>
                    <span>Total Price:</span><strong>â‚±{{ order.total_price|floatformat:2 }}</strong>
                    <span>Payment:</span><strong>{{ order.payment_method|default:'Cash'|title }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No approved orders found.</p></div>
        {% endfor %}
    </div>
</section>

<!-- Pending orders section -->
 <section class="order-section" data-section-status="pending">
    <h2 class="section-title">Pending Orders</h2>
    {% if pending_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="pending">
        <label>Select All Pending</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in pending_orders %}
        <div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            
            <input type="checkbox" class="order-checkbox pending-checkbox" value="{{ order.id }}">
            
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Quantity:</span><strong>{{ order.quantity }}</strong>
                    <span>Total Price:</span><strong>â‚±{{ order.total_price|floatformat:2 }}</strong>
                    <span>Payment:</span><strong>{{ order.payment_method|default:'Cash'|title }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No pending orders found.</p></div>
        {% endfor %}
    </div>
</section>

<!-- Completed Orders Section -->
<section class="order-section" data-section-status="completed">
    <h2 class="section-title">Completed Orders</h2>
    {% if completed_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="completed">
        <label>Select All Completed</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in completed_orders %}
        <div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            <input type="checkbox" class="order-checkbox completed-checkbox" value="{{ order.id }}">
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Quantity:</span><strong>{{ order.quantity }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No completed orders found.</p></div>
        {% endfor %}
    </div>
</section>

<!-- Cancelled/Rejected Orders Section -->
<section class="order-section" data-section-status="cancelled rejected">
    <h2 class="section-title">Cancelled & Rejected Orders</h2>
    {% if other_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="other">
        <label>Select All Cancelled/Rejected</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in other_orders %}
        <div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            <input type="checkbox" class="order-checkbox other-checkbox" value="{{ order.id }}">
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Status:</span><strong>{{ order.status|title }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No cancelled or rejected orders found.</p></div>
        {% endfor %}
    </div>
</section>


<!-- ACTION BARS -->
<div id="batch-status-bar" class="batch-action-bar" style="display: none;">
    <span id="status-selected-count">0 items selected</span>
    <div>
        <label for="batch-status-select" style="margin-right: 0.5rem; font-size: 14px;">Change status to:</label>
        <select id="batch-status-select" class="status-select">
            <option value="approved">Approved</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
        </select>
        <button type="button" class="btn btn-primary" id="batch-status-update-btn" style="margin-left: 1rem;">Update</button>
    </div>
</div>

<div id="batch-pending-status-bar" class="batch-action-bar" style="display: none;">
    <span id="pending-status-selected-count">0 items selected</span>
    <div>
        <label for="batch-pending-status-select" style="margin-right: 0.5rem; font-size: 14px;">Change status to:</label>
        <select id="batch-pending-status-select" class="status-select">
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
        </select>
        <button type="button" class="btn btn-primary" id="batch-pending-status-update-btn" style="margin-left: 1rem;">Update</button>
    </div>
</div>

<div id="batch-delete-bar" class="batch-action-bar" style="display: none;">
    <span id="delete-selected-count">0 items selected</span>
    <button type="button" class="btn btn-danger" id="batch-delete-btn">Delete Selected</button>
</div>

<!-- MODAL -->
<div id="order-details-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Order Details</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-image-container">
                    <img id="details-image" src="" alt="Product Image" class="details-image">
                </div>
                <div class="details-info">
                    <div class="details-header-with-badge"> 
<h3 id="details-name" class="details-name"></h3>
                       <span id="details-status-badge" class="status-badge"></span>
</div>
<div class="details-summary-grid">
                        <span>Order ID:</span><strong id="details-order-id"></strong>
                        <span>Type:</span><strong id="details-order-type"></strong>
                        <span>Student:</span><strong id="details-student"></strong>
                        <span>Date Ordered:</span><strong id="details-created-at"></strong>
                        <span>Product Category:</span><strong id="details-category"></strong>
                        <span>Quantity:</span><strong id="details-quantity"></strong>
                        <span>Total Price:</span><strong id="details-total-price"></strong>
                        <span>Payment Method:</span><strong id="details-payment-method"></strong>
                    </div>
                    <p id="details-description" style="margin-top: 1rem; border-top: 1px solid #f1f5f9; padding-top: 1rem;"></p>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <form id="single-status-form" method="POST" action="">
                {% csrf_token %}
                <label for="single-status-select">Status:</label>
                <select name="status" id="single-status-select" class="status-select">
                    <option value="approved">Approved</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="rejected">Rejected</option>
                </select>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </form>

            <form id="single-pending-status-form" method="POST" action="" style="display: none;">
        {% csrf_token %}
        <label for="single-pending-status-select">Status:</label>
        <select name="status" id="single-pending-status-select" class="status-select">
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
        </select>
        <button type="submit" class="btn btn-primary">Update Status</button>
            </form>
            
              <form id="single-delete-form" method="POST" action="" style="display: none;"> Â  Â  Â  Â  
                {% csrf_token %}
                <button type="button" class="btn btn-danger" id="open-single-delete-modal-btn">Â  Â  Â  Â  Â  Â      
                Delete Order
Â  Â  Â  Â       </button>
Â  Â           </form>
        </div>

        
    </div>
</div>

<!-- âœ… NEW: Batch Delete Confirmation Modal -->
<div id="batch-delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header"><h2>Confirm Batch Deletion</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <p>Are you sure you want to permanently delete <strong id="batch-delete-count">0</strong> order(s)?</p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-batch-delete-btn">Yes, Delete Selected</button>
        </div>
    </div>
</div>

<div id="single-delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header"><h2>Confirm Deletion</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <p>Are you sure you want to permanently delete this order?
               (<strong id="single-delete-order-id">#...</strong>)
            </p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-single-delete-btn">Yes, Delete Order</button>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
Â  Â  // --- Get Elements ---
Â  Â  const detailsModal = document.getElementById('order-details-modal');
Â  Â  const batchStatusForm = document.getElementById('batch-status-form');
Â  Â  const batchDeleteForm = document.getElementById('batch-delete-form');
    const singleDeleteConfirmModal = document.getElementById('single-delete-confirm-modal');
Â  Â  const batchStatusBar = document.getElementById('batch-status-bar');
Â  Â  const batchDeleteBar = document.getElementById('batch-delete-bar');
Â  Â  const batchDeleteConfirmModal = document.getElementById('batch-delete-confirm-modal');
    const batchPendingStatusBar = document.getElementById('batch-pending-status-bar');
    const batchPendingStatusForm = document.getElementById('batch-pending-status-form');

Â  Â  // ðŸ”‘ NEW/UPDATED: Get all cards for filtering
Â  Â  const searchInput = document.getElementById('admin-order-search');
Â  Â  const orderSections = document.querySelectorAll('.order-section');
Â  Â  const allOrderCards = document.querySelectorAll('.order-card');
Â  Â  const allCheckboxes = document.querySelectorAll('.order-checkbox');
Â  Â  const selectAllCheckboxes = document.querySelectorAll('.select-all-checkbox'); // Moved up for scope

Â  Â  // --- Modal Logic ---
Â  Â  const openModal = (modal) => modal.style.display = 'flex';
Â  Â  const closeModal = (modal) => modal.style.display = 'none';
Â  Â  document.querySelectorAll('.close-btn, .cancel-modal-btn').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', () => closeModal(btn.closest('.modal')));
Â  Â  });
Â  Â  window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target); });

Â  Â  // ðŸ”‘ MODIFIED: Order Card Click Listener - Handles both checkbox toggle and modal opening
Â  Â  document.querySelectorAll('.order-card').forEach(card => {
Â  Â  Â  Â  card.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  const checkbox = card.querySelector('.order-checkbox');

Â  Â  Â  Â  Â  Â  // Check if the click target is a control (checkbox, select, or button)
Â  Â  Â  Â  Â  Â  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') {
Â  Â  Â  Â  Â  Â  Â  Â  // If it's a control, we do NOT open the modal.
Â  Â  Â  Â  Â  Â  Â  Â  // We also ensure the click on the checkbox doesn't propagate to the card itself (optional but safer)
Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.classList.contains('order-checkbox')) e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Checkbox Toggling (Action Checkbox Functionality) ---
Â  Â  Â  Â  Â  Â  if (checkbox) {
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = !checkbox.checked; // Toggle the checkbox state
Â  Â  Â  Â  Â  Â  Â  Â  // Manually trigger the change event to update the action bars
Â  Â  Â  Â  Â  Â  Â  Â  checkbox.dispatchEvent(new Event('change'));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- Modal Opening Logic ---
Â  Â  Â  Â  Â  Â  const data = card.dataset;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-image').src = data.imageUrl;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-name').textContent = data.size ? `${data.name} - ${data.size}` : data.name;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-order-id').textContent = `#${data.id}`;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-student').textContent = `${data.studentName} (${data.studentId})`;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-category').textContent = data.category;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-description').textContent = data.description;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-created-at').textContent = data.createdAt;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-quantity').textContent = `${data.quantity} pc(s)`;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-total-price').textContent = `â‚±${data.totalPrice}`;
Â  Â  Â  Â  Â  Â  detailsModal.querySelector('#details-payment-method').textContent = data.paymentMethod;
            detailsModal.querySelector('#details-order-type').textContent = data.orderType; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const statusBadge = detailsModal.querySelector('#details-status-badge');
Â  Â  Â  Â  Â  Â  const status = data.status;
Â  Â  Â  Â  Â  Â  statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
Â  Â  Â  Â  Â  Â  statusBadge.className = 'status-badge'; 
Â  Â  Â  Â  Â  Â  statusBadge.classList.add(`status-${status}`);

Â  Â  Â  Â  Â  Â  // --- âœ… NEW Modal Footer Logic ---
Â  Â  Â  Â  Â  Â  const singleStatusForm = detailsModal.querySelector('#single-status-form');
            const singlePendingStatusForm = detailsModal.querySelector('#single-pending-status-form');
            const singleDeleteForm = detailsModal.querySelector('#single-delete-form');

            // 1. Hide all forms by default
            singleStatusForm.style.display = 'none';
            singlePendingStatusForm.style.display = 'none';
            singleDeleteForm.style.display = 'none';

            // 2. Set action URLs for all forms
            singleStatusForm.action = `/dashboard/admin/update-order-status/${data.id}/`;
            singlePendingStatusForm.action = `/dashboard/admin/update-order-status/${data.id}/`;
            singleDeleteForm.action = `/dashboard/admin/delete-order/${data.id}/`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 3. Show the correct form based on status
            if (data.status === 'approved') {
                // Show the full status form for 'approved'
                singleStatusForm.style.display = 'flex';
                singleStatusForm.querySelector('#single-status-select').value = data.status;
            } else if (data.status === 'pending') {
                // Show the limited 'Cancelled/Rejected' form for 'pending'
                singlePendingStatusForm.style.display = 'flex';
            } else {
                // Show the 'Delete' button for 'completed', 'cancelled', 'rejected'
                singleDeleteForm.style.display = 'block';
            }
            openModal(detailsModal);
Â  Â  Â  Â  });
Â  Â  });

// ðŸ”‘ STEP 1 & 2: Implement Live Search Logic
Â  Â  function filterOrders() {
Â  Â  Â  Â  const query = searchInput.value.toLowerCase().trim();
Â  Â  Â  Â  let sectionVisibleCardCount = {};
Â  Â  Â  Â  
Â  Â  Â  Â  // Initialize counts for sections
Â  Â  Â  Â  orderSections.forEach(section => {
Â  Â  Â  Â  Â  Â  sectionVisibleCardCount[section.dataset.sectionStatus.split(' ')[0]] = 0;
Â  Â  Â  Â  });

Â  Â  Â  Â  allOrderCards.forEach(card => {
Â  Â  Â  Â  Â  Â  // Get all data attributes for searching (Your specified fields)
Â  Â  Â  Â  Â  Â  const id = card.dataset.id || '';
Â  Â  Â  Â  Â  Â  const name = card.dataset.name.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  const category = card.dataset.category.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  const status = card.dataset.status.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  const studentName = card.dataset.studentName.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  const studentId = card.dataset.studentId.toLowerCase() || '';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Combine fields for simple includes check
Â  Â  Â  Â  Â  Â  const searchableText = `${id} ${name} ${category} ${status} ${studentName} ${studentId}`;

Â  Â  Â  Â  Â  Â  let isVisible = true;

Â  Â  Â  Â  Â  Â  if (query.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!searchableText.includes(query)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isVisible = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Show or hide the card based on the filter
Â  Â  Â  Â  Â  Â  card.style.display = isVisible ? 'flex' : 'none';

Â  Â  Â  Â  Â  Â  // If visible, increment the counter for its section
Â  Â  Â  Â  Â  Â  if (isVisible) {
Â  Â  Â  Â  Â  Â  Â  Â  // Find the parent section status to categorize the visible card
Â  Â  Â  Â  Â  Â  Â  Â  const section = card.closest('.order-section');
Â  Â  Â  Â  Â  Â  Â  Â  if (section) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Use the first status word (e.g., 'approved', 'completed', 'cancelled')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const primaryStatus = section.dataset.sectionStatus.split(' ')[0]; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sectionVisibleCardCount[primaryStatus]++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // ðŸ”‘ STEP 3: Update section visibility and "no results" messages
Â  Â  Â  Â  updateSectionVisibility(query, sectionVisibleCardCount);
Â  Â  Â  Â  updateActionBars(); // Ensure action bars reflect the current visible/checked cards
Â  Â  }

Â  Â  // Helper to manage 'no data' cells and section titles
Â  Â  function updateSectionVisibility(query, visibleCounts) {
Â  Â  Â  Â  orderSections.forEach(section => {
Â  Â  Â  Â  Â  Â  const grid = section.querySelector('.orders-grid');
Â  Â  Â  Â  Â  Â  const primaryStatus = section.dataset.sectionStatus.split(' ')[0];
Â  Â  Â  Â  Â  Â  const originalNoDataCell = section.querySelector('.no-data-cell:not(.temp-no-results)');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Find or create the temporary 'no results' cell
Â  Â  Â  Â  Â  Â  let tempNoResults = section.querySelector('.temp-no-results');
Â  Â  Â  Â  Â  Â  if (!tempNoResults) {
Â  Â  Â  Â  Â  Â  Â  Â  tempNoResults = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  tempNoResults.className = 'no-data-cell temp-no-results';
Â  Â  Â  Â  Â  Â  Â  Â  tempNoResults.innerHTML = '<p>No matching orders found.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  grid.appendChild(tempNoResults);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isVisible = visibleCounts[primaryStatus] > 0;

Â  Â  Â  Â  Â  Â  if (query.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // Search is active
Â  Â  Â  Â  Â  Â  Â  Â  if (!isVisible) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempNoResults.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (originalNoDataCell) originalNoDataCell.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempNoResults.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Search is cleared/inactive
Â  Â  Â  Â  Â  Â  Â  Â  tempNoResults.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (originalNoDataCell) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const totalCards = section.querySelectorAll('.order-card').length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  originalNoDataCell.style.display = (totalCards === 0) ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // Attach listener to the search input
Â  Â  searchInput.addEventListener('input', filterOrders);
Â  Â  
Â  Â  // Run the filter once on load to initialize visibility state
Â  Â  filterOrders();

Â  Â  // --- Batch Action Logic ---
Â  Â  function updateActionBars() {
Â  Â  Â  Â  const approvedChecked = document.querySelectorAll('.approved-checkbox:checked').length;
Â  Â  Â  Â  const completedChecked = document.querySelectorAll('.completed-checkbox:checked').length;
Â  Â  Â  Â  const otherChecked = document.querySelectorAll('.other-checkbox:checked').length;
        const pendingChecked = document.querySelectorAll('.pending-checkbox:checked').length;
Â  Â  Â  Â  
        // âœ… Control 'Approved' bar
        batchStatusBar.style.display = approvedChecked > 0 ? 'flex' : 'none';
Â  Â  Â  Â  batchStatusBar.querySelector('#status-selected-count').textContent = `${approvedChecked} item(s) selected`;

       // âœ… Control new 'Pending' bar
        batchPendingStatusBar.style.display = pendingChecked > 0 ? 'flex' : 'none';
Â  Â  Â  Â  batchPendingStatusBar.querySelector('#pending-status-selected-count').textContent = `${pendingChecked} item(s) selected`;
        
        // âœ… Control 'Delete' bar 
Â  Â  Â  Â  const deleteCount = completedChecked + otherChecked;
Â  Â  Â  Â  batchDeleteBar.style.display = deleteCount > 0 ? 'flex' : 'none';
Â  Â  Â  Â  batchDeleteBar.querySelector('#delete-selected-count').textContent = `${deleteCount} item(s) selected`;

Â  Â  Â  Â  // ðŸ”‘ FIX 1: Only apply the 'selected' class to the card if it is NOT hidden.
Â  Â  Â  Â  allCheckboxes.forEach(cb => {
Â  Â  Â  Â  Â  Â  const card = cb.closest('.order-card');
Â  Â  Â  Â  Â  Â  if (card) {
Â  Â  Â  Â  Â  Â  Â  Â  // Toggle 'selected' class only if the checkbox is checked AND the card is visible
Â  Â  Â  Â  Â  Â  Â  Â  card.classList.toggle('selected', cb.checked && card.style.display !== 'none');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Ensure hidden cards lose the 'selected' class just in case
Â  Â  Â  Â  Â  Â  Â  Â  if (card.style.display === 'none') card.classList.remove('selected');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  selectAllCheckboxes.forEach(sa => {
Â  Â  Â  Â  sa.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  const clickedSection = sa.dataset.section;
Â  Â  Â  Â  Â  Â  const clickedGroupClass = `${clickedSection}-checkbox`;

Â  Â  Â  Â  Â  Â  // --- Original Logic: Check all in this section ---
Â  Â  Â  Â  Â  Â  document.querySelectorAll(`.${clickedGroupClass}`).forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  const card = cb.closest('.order-card');
Â  Â  Â  Â  Â  Â  Â  Â  if (card && card.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = sa.checked;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (sa.checked === false) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = false;
Â  Â  Â  Â  Â  Â  Â  _}
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // --- âœ… NEW: Clear all other sections if this one is being checked ---
Â  Â  Â  Â  Â  Â  if (sa.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  // Uncheck all individual checkboxes in other groups
Â  Â  Â  Â  Â  Â  Â  Â  allCheckboxes.forEach(cb => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!cb.classList.contains(clickedGroupClass)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Uncheck all *other* "Select All" toggles
Â  Â  Â  Â  Â  Â  Â  Â  selectAllCheckboxes.forEach(otherSA => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (otherSA !== sa) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  otherSA.checked = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // --- Original Logic: Update bars ---
Â  Â  Â  Â  Â  Â  updateActionBars();
Â  Â  Â  Â  });
Â  Â  });

Â  Â  // âœ… NEW: Function to handle exclusive section selection
Â  Â  function handleExclusiveSelection(e) {
Â  Â  Â  Â  const clickedCheckbox = e.currentTarget;
Â  Â  Â  Â  let clickedGroup = null;

Â  Â  Â  Â  // 1. Identify the group of the clicked checkbox
Â  Â  Â  Â  if (clickedCheckbox.classList.contains('approved-checkbox')) {
Â  Â  Â  Â  Â  Â  clickedGroup = 'approved-checkbox';
Â  Â  Â  Â  } else if (clickedCheckbox.classList.contains('pending-checkbox')) {
Â  Â  Â  Â  Â  Â  clickedGroup = 'pending-checkbox';
Â  Â  Â  Â  } else if (clickedCheckbox.classList.contains('completed-checkbox')) {
Â  Â  Â  Â  Â  Â  clickedGroup = 'completed-checkbox';
Â  Â  Â  Â  } else if (clickedCheckbox.classList.contains('other-checkbox')) {
Â  Â  Â  Â  Â  Â  clickedGroup = 'other-checkbox';
Â  Â  Â  Â  }

Â  Â  Â  Â  // If the click was to UNCHECK, or if it's not part of a group,
Â  Â  Â  Â  // just update the bars and exit.
Â  Â  Â  Â  if (!clickedCheckbox.checked || !clickedGroup) {
Â  Â  Â  Â  Â  Â  updateActionBars();
Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Uncheck all checkboxes in OTHER groups
Â  Â  Â  Â  allCheckboxes.forEach(cb => {
Â  Â  Â  Â  Â  Â  if (cb === clickedCheckbox) return; // Don't uncheck the one we just clicked

Â  Â  Â  Â  Â  Â  let cbGroup = null;
Â  Â  Â  Â  Â  Â  if (cb.classList.contains('approved-checkbox')) cbGroup = 'approved-checkbox';
 Â  Â  Â  Â  else if (cb.classList.contains('pending-checkbox')) cbGroup = 'pending-checkbox';
Â  Â  Â  Â  Â  Â  else if (cb.classList.contains('completed-checkbox')) cbGroup = 'completed-checkbox';
Â  Â  Â  Â  Â  Â  else if (cb.classList.contains('other-checkbox')) cbGroup = 'other-checkbox';

Â  Â  Â  Â  Â  Â  if (cbGroup && cbGroup !== clickedGroup) {
Â  Â  Â  Â  Â  Â  Â  Â  cb.checked = false;
Â   Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 3. Uncheck all "Select All" toggles for OTHER groups
Â  Â  Â  Â  selectAllCheckboxes.forEach(sa => {
Â  Â  Â  Â  Â  Â  const sectionGroup = `${sa.dataset.section}-checkbox`;
Â  Â  Â  Â  Â  Â  if (sectionGroup !== clickedGroup) {
Â  Â  Â  Â  Â  Â  Â  Â  sa.checked = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 4. Update the action bars based on the new state
 Â  Â  Â  updateActionBars();
Â  Â  }

Â  Â  // âœ… MODIFIED: Apply the new exclusive handler to all checkboxes
Â  Â  allCheckboxes.forEach(cb => cb.addEventListener('change', handleExclusiveSelection));

Â  Â  // Batch Status Update
Â  Â  document.getElementById('batch-status-update-btn').addEventListener('click', () => {
Â  Â  Â  Â  const selectedIds = Array.from(document.querySelectorAll('.approved-checkbox:checked')).map(cb => cb.value);
Â  Â  Â  Â  if (selectedIds.length > 0) {
Â  Â  Â  Â  Â  Â  batchStatusForm.action = `/dashboard/admin/update-order-status/0/`;
Â  Â  Â  Â  Â  Â  batchStatusForm.querySelector('#batch-status-order-ids').value = selectedIds.join(',');
Â  Â  Â  Â  Â  Â  batchStatusForm.querySelector('#batch-status-action').value = document.getElementById('batch-status-select').value;
Â  Â  Â  Â  Â  Â  batchStatusForm.submit();
Â  Â  Â  Â  }
Â  Â  });

// âœ… NEW: Add this listener for the 'Pending' section
    document.getElementById('batch-pending-status-update-btn').addEventListener('click', () => {
        const selectedIds = Array.from(document.querySelectorAll('.pending-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length > 0) {
            batchPendingStatusForm.action = `/dashboard/admin/update-order-status/0/`;
            batchPendingStatusForm.querySelector('#batch-pending-status-order-ids').value = selectedIds.join(',');
            batchPendingStatusForm.querySelector('#batch-pending-status-action').value = document.getElementById('batch-pending-status-select').value;
            batchPendingStatusForm.submit();
        }
    });

Â  Â  // âœ… UPDATED: Batch Delete button now opens the confirmation modal
Â  Â  document.getElementById('batch-delete-btn').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const selectedIds = Array.from(document.querySelectorAll('.completed-checkbox:checked, .other-checkbox:checked')).map(cb => cb.value);
            // âœ… FIX: Calculate count here
            const count = selectedIds.length;
Â  Â  Â  Â  Â  Â  
            if (count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // Populate and open the custom modal
Â  Â  Â  Â  Â  Â  Â  Â  batchDeleteConfirmModal.querySelector('#batch-delete-count').textContent = count;
Â  Â  Â  Â  Â  Â  Â  Â  // Store IDs on the confirm button inside the modal to be used later
Â  Â  Â  Â  Â  Â  Â  Â  const confirmBtn = batchDeleteConfirmModal.querySelector('#confirm-batch-delete-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (confirmBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.dataset.ids = selectedIds.join(',');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  openModal(batchDeleteConfirmModal);
Â  Â  Â  Â  Â  Â  }
Â  Â  });

Â  Â  // âœ… NEW: Event listener for the final confirmation button inside the modal
Â  Â  const confirmBatchDeleteBtn = document.getElementById('confirm-batch-delete-btn');
Â  Â  if (confirmBatchDeleteBtn) {
Â  Â  Â  Â  confirmBatchDeleteBtn.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  const idsToSubmit = this.dataset.ids;
Â  Â  Â  Â  Â  Â  if (idsToSubmit) {
Â  Â  Â  Â  Â  Â  Â  Â  batchDeleteForm.querySelector('#batch-delete-order-ids').value = idsToSubmit;
Â  Â  Â  Â  Â  Â  Â  Â  batchDeleteForm.submit();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
// --- âœ… NEW: Single Delete Modal Logic ---
Â  Â  const openSingleDeleteModalBtn = document.getElementById('open-single-delete-modal-btn');
Â  Â  const confirmSingleDeleteBtn = document.getElementById('confirm-single-delete-btn');
Â  Â  const singleDeleteForm = document.getElementById('single-delete-form');
Â  Â  
Â  Â  // 1. Listen for click on the "Delete Order" button (in main modal)
Â  Â  if (openSingleDeleteModalBtn && singleDeleteForm) {
Â  Â  Â  Â  openSingleDeleteModalBtn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault(); // Stop any default form action
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Get the order ID from the form's action URL
Â  Â  Â  Â  Â  Â  const actionUrl = singleDeleteForm.action; 
Â  Â  Â  Â  Â  Â  const orderId = actionUrl.split('/delete-order/')[1].replace('/', '');

Â  Â  Â  Â  Â  Â  // Populate the new modal's text
Â  Â  Â  Â  Â  Â  const orderIdSpan = document.getElementById('single-delete-order-id');
Â  Â  Â  Â  Â  Â  if (orderIdSpan) orderIdSpan.textContent = `#${orderId}`;

Â  Â  Â  Â  Â  Â  // Open the new confirmation modal
Â  Â  Â  Â  Â  Â  openModal(singleDeleteConfirmModal);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 2. Listen for click on the FINAL confirmation button (in the new modal)
Â  Â  if (confirmSingleDeleteBtn && singleDeleteForm) {
Â  Â  Â  Â  confirmSingleDeleteBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  // Now, we submit the form
Â  Â  Â  Â  Â  Â  singleDeleteForm.submit();
Â  Â  Â  Â  });
Â  Â  }

Â  Â  updateActionBars(); // Initial check
});
</script>
{% endblock %}