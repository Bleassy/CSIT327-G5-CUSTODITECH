{% extends 'dashboards/admin_base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/order_management.css' %}?v=1.3"> {# Incremented version #}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Order & Reservation Management</h1>
</div>

<div class="page-controls">
    <div class="search-form">
        <input type="search" id="admin-order-search" class="search-input" placeholder="Search by Student Name/ID, Product Name, Category, or Status..." value="{{ search_query }}">
    </div>
</div>

<!-- Form for Batch Status Update (Approved section) -->
<form id="batch-status-form" method="POST" action="{% url 'update_order_status' order_id=0 %}"> {# Dummy URL, will be overridden #}
    {% csrf_token %}
    <input type="hidden" name="order_ids" id="batch-status-order-ids">
    <input type="hidden" name="status" id="batch-status-action">
</form>

<!-- ✅ UPDATED: Form for Batch Deletion (Completed/Other sections) now points to the correct admin URL -->
<form id="batch-delete-form" method="POST" action="{% url 'admin_batch_delete_orders' %}">
    {% csrf_token %}
    <input type="hidden" name="order_ids" id="batch-delete-order-ids">
</form>

<form id="batch-pending-status-form" method="POST" action="{% url 'update_order_status' order_id=0 %}">
    {% csrf_token %}
    <input type="hidden" name="order_ids" id="batch-pending-status-order-ids">
    <input type="hidden" name="status" id="batch-pending-status-action">
</form>


<!-- Approved Orders Section -->
<section class="order-section" data-section-status="approved">
    <h2 class="section-title">Approved Orders</h2>
    {% if approved_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="approved">
        <label>Select All Approved</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in approved_orders %}
<div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            <input type="checkbox" class="order-checkbox approved-checkbox" value="{{ order.id }}">
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Quantity:</span><strong>{{ order.quantity }}</strong>
                    <span>Total Price:</span><strong>₱{{ order.total_price|floatformat:2 }}</strong>
                    <span>Payment:</span><strong>{{ order.payment_method|default:'Cash'|title }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No approved orders found.</p></div>
        {% endfor %}
    </div>
</section>

<!-- Pending orders section -->
 <section class="order-section" data-section-status="pending">
    <h2 class="section-title">Pending Orders</h2>
    {% if pending_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="pending">
        <label>Select All Pending</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in pending_orders %}
        <div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            
            <input type="checkbox" class="order-checkbox pending-checkbox" value="{{ order.id }}">
            
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Quantity:</span><strong>{{ order.quantity }}</strong>
                    <span>Total Price:</span><strong>₱{{ order.total_price|floatformat:2 }}</strong>
                    <span>Payment:</span><strong>{{ order.payment_method|default:'Cash'|title }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No pending orders found.</p></div>
        {% endfor %}
    </div>
</section>

<!-- Completed Orders Section -->
<section class="order-section" data-section-status="completed">
    <h2 class="section-title">Completed Orders</h2>
    {% if completed_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="completed">
        <label>Select All Completed</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in completed_orders %}
        <div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            <input type="checkbox" class="order-checkbox completed-checkbox" value="{{ order.id }}">
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Quantity:</span><strong>{{ order.quantity }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No completed orders found.</p></div>
        {% endfor %}
    </div>
</section>

<!-- Cancelled/Rejected Orders Section -->
<section class="order-section" data-section-status="cancelled rejected">
    <h2 class="section-title">Cancelled & Rejected Orders</h2>
    {% if other_orders %}
    <div class="select-all-container">
        <input type="checkbox" class="select-all-checkbox" data-section="other">
        <label>Select All Cancelled/Rejected</label>
    </div>
    {% endif %}
    <div class="orders-grid">
        {% for order in other_orders %}
        <div class="order-card" data-id="{{ order.id }}" data-order-type="{{ order.order_type|title|default:'N/A' }}" data-name="{{ order.product_name }}" data-size="{{ order.product_size|default:'' }}" data-category="{{ order.product_category|default:'N/A' }}" data-description="{{ order.product_description|default:'No description available.' }}" data-image-url="{{ order.product_image_url|default:'...' }}" data-quantity="{{ order.quantity }}" data-total-price="{{ order.total_price|floatformat:2 }}" data-payment-method="{{ order.payment_method|default:'Cash'|title }}" data-created-at="{{ order.created_at|date:'M d, Y' }}" data-status="{{ order.status }}" data-student-name="{{ order.student_name|default:'N/A' }}" data-student-id="{{ order.student_id|default:'N/A' }}">
            <span class="status-badge status-{{ order.status }}">{{ order.status|title }}</span>
            <input type="checkbox" class="order-checkbox other-checkbox" value="{{ order.id }}">
            <img src="{{ order.product_image_url|default:'...' }}" alt="{{ order.product_name }}" class="product-image">
            <div class="card-body">
                <h3 class="product-name">{{ order.product_name }}{% if order.product_size %} - {{ order.product_size }}{% endif %}</h3>
                <div class="details-grid">
                    <span>Order ID:</span><strong>#{{ order.id }}</strong>
                    <span>Type:</span><strong>{{ order.order_type|title|default:'N/A' }}</strong>
                    <span>Student:</span><strong>{{ order.student_name|default:'N/A' }} ({{ order.student_id|default:'N/A' }})</strong>
                    <span>Date:</span><strong>{{ order.created_at|date:"M d, Y" }}</strong>
                    <span>Status:</span><strong>{{ order.status|title }}</strong>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-data-cell"><p>No cancelled or rejected orders found.</p></div>
        {% endfor %}
    </div>
</section>


<!-- ACTION BARS -->
<div id="batch-status-bar" class="batch-action-bar" style="display: none;">
    <span id="status-selected-count">0 items selected</span>
    <div>
        <label for="batch-status-select" style="margin-right: 0.5rem; font-size: 14px;">Change status to:</label>
        <select id="batch-status-select" class="status-select">
            <option value="approved">Approved</option>
            <option value="completed">Completed</option>
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
        </select>
        <button type="button" class="btn btn-primary" id="batch-status-update-btn" style="margin-left: 1rem;">Update</button>
    </div>
</div>

<div id="batch-pending-status-bar" class="batch-action-bar" style="display: none;">
    <span id="pending-status-selected-count">0 items selected</span>
    <div>
        <label for="batch-pending-status-select" style="margin-right: 0.5rem; font-size: 14px;">Change status to:</label>
        <select id="batch-pending-status-select" class="status-select">
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
        </select>
        <button type="button" class="btn btn-primary" id="batch-pending-status-update-btn" style="margin-left: 1rem;">Update</button>
    </div>
</div>

<div id="batch-delete-bar" class="batch-action-bar" style="display: none;">
    <span id="delete-selected-count">0 items selected</span>
    <button type="button" class="btn btn-danger" id="batch-delete-btn">Delete Selected</button>
</div>

<!-- MODAL -->
<div id="order-details-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Order Details</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-image-container">
                    <img id="details-image" src="" alt="Product Image" class="details-image">
                </div>
                <div class="details-info">
                    <div class="details-header-with-badge"> 
<h3 id="details-name" class="details-name"></h3>
                       <span id="details-status-badge" class="status-badge"></span>
</div>
<div class="details-summary-grid">
                        <span>Order ID:</span><strong id="details-order-id"></strong>
                        <span>Type:</span><strong id="details-order-type"></strong>
                        <span>Student:</span><strong id="details-student"></strong>
                        <span>Date Ordered:</span><strong id="details-created-at"></strong>
                        <span>Product Category:</span><strong id="details-category"></strong>
                        <span>Quantity:</span><strong id="details-quantity"></strong>
                        <span>Total Price:</span><strong id="details-total-price"></strong>
                        <span>Payment Method:</span><strong id="details-payment-method"></strong>
                    </div>
                    <p id="details-description" style="margin-top: 1rem; border-top: 1px solid #f1f5f9; padding-top: 1rem;"></p>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <form id="single-status-form" method="POST" action="">
                {% csrf_token %}
                <label for="single-status-select">Status:</label>
                <select name="status" id="single-status-select" class="status-select">
                    <option value="approved">Approved</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="rejected">Rejected</option>
                </select>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </form>

            <form id="single-pending-status-form" method="POST" action="" style="display: none;">
        {% csrf_token %}
        <label for="single-pending-status-select">Status:</label>
        <select name="status" id="single-pending-status-select" class="status-select">
            <option value="cancelled">Cancelled</option>
            <option value="rejected">Rejected</option>
        </select>
        <button type="submit" class="btn btn-primary">Update Status</button>
            </form>
            
              <form id="single-delete-form" method="POST" action="" style="display: none;">         
                {% csrf_token %}
                <button type="button" class="btn btn-danger" id="open-single-delete-modal-btn">                
                Delete Order
             </button>
             </form>
        </div>

        
    </div>
</div>

<!-- ✅ NEW: Batch Delete Confirmation Modal -->
<div id="batch-delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header"><h2>Confirm Batch Deletion</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <p>Are you sure you want to permanently delete <strong id="batch-delete-count">0</strong> order(s)?</p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-batch-delete-btn">Yes, Delete Selected</button>
        </div>
    </div>
</div>

<div id="single-delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header"><h2>Confirm Deletion</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <p>Are you sure you want to permanently delete this order?
               (<strong id="single-delete-order-id">#...</strong>)
            </p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-single-delete-btn">Yes, Delete Order</button>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // ==================================================================
    // == 1. GET ALL ELEMENTS
    // ==================================================================
    const detailsModal = document.getElementById('order-details-modal');
    const batchDeleteConfirmModal = document.getElementById('batch-delete-confirm-modal');
    const singleDeleteConfirmModal = document.getElementById('single-delete-confirm-modal');

    // --- Forms ---
    const batchStatusForm = document.getElementById('batch-status-form');
    const batchPendingStatusForm = document.getElementById('batch-pending-status-form');
    const batchDeleteForm = document.getElementById('batch-delete-form');
    const singleStatusForm = document.getElementById('single-status-form');
    const singlePendingStatusForm = document.getElementById('single-pending-status-form');
    const singleDeleteForm = document.getElementById('single-delete-form');

    // --- Action Bars ---
    const batchStatusBar = document.getElementById('batch-status-bar');
    const batchPendingStatusBar = document.getElementById('batch-pending-status-bar');
    const batchDeleteBar = document.getElementById('batch-delete-bar');
    
    // --- Buttons ---
    const batchStatusUpdateBtn = document.getElementById('batch-status-update-btn');
    const batchPendingStatusUpdateBtn = document.getElementById('batch-pending-status-update-btn');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    const confirmBatchDeleteBtn = document.getElementById('confirm-batch-delete-btn');
    const openSingleDeleteModalBtn = document.getElementById('open-single-delete-modal-btn');
    const confirmSingleDeleteBtn = document.getElementById('confirm-single-delete-btn');
    
    // --- Search & Content ---
    const searchInput = document.getElementById('admin-order-search');
    const orderSections = document.querySelectorAll('.order-section');
    const allCheckboxes = document.querySelectorAll('.order-checkbox');
    const selectAllCheckboxes = document.querySelectorAll('.select-all-checkbox');

    // ==================================================================
    // == 2. DEFINE ALL HELPER FUNCTIONS
    // ==================================================================

    /**
     * Displays a temporary message in the message container.
     */
    function showMessage(message, type = 'success') {
        const container = document.getElementById('message-container');
        if (!container) return;
        const li = document.createElement('li');
        li.className = type;
        li.textContent = ` ${message}`;
        const iconSpan = document.createElement('span');
        iconSpan.textContent = (type === 'success') ? '✅' : '❌';
        li.prepend(iconSpan);
        container.appendChild(li);
        setTimeout(() => {
            li.style.opacity = '0';
            setTimeout(() => { li.remove(); }, 500);
        }, 4000);
    }

    /**
     * Gets the CSRF token from any of the forms.
     */
    function getCsrfToken() {
        return document.querySelector('form [name=csrfmiddlewaretoken]').value;
    }

    /**
     * Finds and removes an order card from the DOM.
     */
    function removeOrderCard(orderId) {
        const card = document.querySelector(`.order-card[data-id="${orderId}"]`);
        if (card) {
            card.classList.add('moving'); // Add fade-out animation
            setTimeout(() => {
                card.remove();
                filterOrders(); // Re-check "no data" messages
                updateActionBars();
            }, 300); // Wait for animation
        }
    }

    /**
     * Moves an order card to the correct section based on its new status.
     */
    function moveOrderCard(orderId, newStatus) {
        const card = document.querySelector(`.order-card[data-id="${orderId}"]`);
        if (!card) return;

        let targetGrid, newCheckboxClass;

        // Determine target grid and new checkbox class
        if (newStatus === 'approved') {
            targetGrid = document.querySelector('.order-section[data-section-status="approved"] .orders-grid');
            newCheckboxClass = 'order-checkbox approved-checkbox';
        } else if (newStatus === 'pending') {
            targetGrid = document.querySelector('.order-section[data-section-status="pending"] .orders-grid');
            newCheckboxClass = 'order-checkbox pending-checkbox';
        } else if (newStatus === 'completed') {
            targetGrid = document.querySelector('.order-section[data-section-status="completed"] .orders-grid');
            newCheckboxClass = 'order-checkbox completed-checkbox';
        } else if (newStatus === 'cancelled' || newStatus === 'rejected') {
            targetGrid = document.querySelector('.order-section[data-section-status*="cancelled"] .orders-grid');
            newCheckboxClass = 'order-checkbox other-checkbox';
        }

        if (targetGrid) {
            // Animate card out
            card.classList.add('moving');
            
            setTimeout(() => {
                // Update card data
                card.dataset.status = newStatus;
                
                // Update status badge
                const statusBadge = card.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
                    statusBadge.className = `status-badge status-${newStatus}`;
                }
                
                // Update checkbox
                const checkbox = card.querySelector('.order-checkbox');
                if (checkbox) {
                    checkbox.className = newCheckboxClass;
                    checkbox.checked = false; // Always uncheck on move
                }

                // Move card
                targetGrid.prepend(card);
                
                // Animate card in
                card.classList.remove('moving'); 
                
                // Update UI
                filterOrders(); // Re-check "no data" messages
                updateActionBars();
            }, 300); // Wait for fade-out
        }
    }

    // --- Modal Logic (Unchanged) ---
    const openModal = (modal) => modal.style.display = 'flex';
    const closeModal = (modal) => modal.style.display = 'none';
    document.querySelectorAll('.close-btn, .cancel-modal-btn').forEach(btn => {
        btn.addEventListener('click', () => closeModal(btn.closest('.modal')));
    });
    window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target); });

    // --- Card Click Logic (Unchanged) ---
    document.querySelectorAll('.order-card').forEach(card => {
        card.addEventListener('click', (e) => {
            const checkbox = card.querySelector('.order-checkbox');
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') {
                if (e.target.classList.contains('order-checkbox')) e.stopPropagation();
                return;
            }
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
            const data = card.dataset;
            detailsModal.querySelector('#details-image').src = data.imageUrl;
            detailsModal.querySelector('#details-name').textContent = data.size ? `${data.name} - ${data.size}` : data.name;
            detailsModal.querySelector('#details-order-id').textContent = `#${data.id}`;
            detailsModal.querySelector('#details-student').textContent = `${data.studentName} (${data.studentId})`;
            detailsModal.querySelector('#details-category').textContent = data.category;
            detailsModal.querySelector('#details-description').textContent = data.description;
            detailsModal.querySelector('#details-created-at').textContent = data.createdAt;
            detailsModal.querySelector('#details-quantity').textContent = `${data.quantity} pc(s)`;
            detailsModal.querySelector('#details-total-price').textContent = `₱${data.totalPrice}`;
            detailsModal.querySelector('#details-payment-method').textContent = data.paymentMethod;
            detailsModal.querySelector('#details-order-type').textContent = data.orderType; 
            const statusBadge = detailsModal.querySelector('#details-status-badge');
            const status = data.status;
            statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusBadge.className = 'status-badge'; 
            statusBadge.classList.add(`status-${status}`);
            
            // Set action URLs for all forms
            singleStatusForm.action = `/dashboard/admin/update-order-status/${data.id}/`;
            singlePendingStatusForm.action = `/dashboard/admin/update-order-status/${data.id}/`;
            singleDeleteForm.action = `/dashboard/admin/delete-order/${data.id}/`;
            
            // Show the correct form based on status
            singleStatusForm.style.display = 'none';
            singlePendingStatusForm.style.display = 'none';
            singleDeleteForm.style.display = 'none';

            if (data.status === 'approved') {
                singleStatusForm.style.display = 'flex';
                singleStatusForm.querySelector('#single-status-select').value = data.status;
            } else if (data.status === 'pending') {
                singlePendingStatusForm.style.display = 'flex';
            } else {
                singleDeleteForm.style.display = 'block';
            }
            openModal(detailsModal);
        });
    });

    // --- Filter/Search Logic (Unchanged) ---
    function filterOrders() {
        const query = searchInput.value.toLowerCase().trim();
        let sectionVisibleCardCount = {};
        orderSections.forEach(section => {
            sectionVisibleCardCount[section.dataset.sectionStatus.split(' ')[0]] = 0;
        });
        document.querySelectorAll('.order-card').forEach(card => {
            const id = card.dataset.id || '';
            const name = card.dataset.name.toLowerCase() || '';
            const category = card.dataset.category.toLowerCase() || '';
            const status = card.dataset.status.toLowerCase() || '';
            const studentName = card.dataset.studentName.toLowerCase() || '';
            const studentId = card.dataset.studentId.toLowerCase() || '';
            const searchableText = `${id} ${name} ${category} ${status} ${studentName} ${studentId}`;
            let isVisible = true;
            if (query.length > 0) {
                if (!searchableText.includes(query)) {
                    isVisible = false;
                }
            }
            card.style.display = isVisible ? 'flex' : 'none';
            if (isVisible) {
                const section = card.closest('.order-section');
                if (section) {
                    const primaryStatus = section.dataset.sectionStatus.split(' ')[0]; 
                    sectionVisibleCardCount[primaryStatus]++;
                }
            }
        });
        updateSectionVisibility(query, sectionVisibleCardCount);
        updateActionBars();
    }
    function updateSectionVisibility(query, visibleCounts) {
        orderSections.forEach(section => {
            const grid = section.querySelector('.orders-grid');
            const primaryStatus = section.dataset.sectionStatus.split(' ')[0];
            const originalNoDataCell = section.querySelector('.no-data-cell:not(.temp-no-results)');
            let tempNoResults = section.querySelector('.temp-no-results');
            if (!tempNoResults) {
                tempNoResults = document.createElement('div');
                tempNoResults.className = 'no-data-cell temp-no-results';
                tempNoResults.innerHTML = '<p>No matching orders found.</p>';
                grid.appendChild(tempNoResults);
            }
            const isVisible = visibleCounts[primaryStatus] > 0;
            if (query.length > 0) {
                if (!isVisible) {
                    tempNoResults.style.display = 'block';
                    if (originalNoDataCell) originalNoDataCell.style.display = 'none';
                } else {
                    tempNoResults.style.display = 'none';
                }
            } else {
                tempNoResults.style.display = 'none';
                if (originalNoDataCell) {
                    const totalCards = section.querySelectorAll('.order-card').length;
                    originalNoDataCell.style.display = (totalCards === 0) ? 'block' : 'none';
                }
            }
        });
    }
    searchInput.addEventListener('input', filterOrders);
    filterOrders();

    // --- Batch Action/Checkbox Logic (Unchanged) ---
    function updateActionBars() {
        const approvedChecked = document.querySelectorAll('.approved-checkbox:checked').length;
        const completedChecked = document.querySelectorAll('.completed-checkbox:checked').length;
        const otherChecked = document.querySelectorAll('.other-checkbox:checked').length;
        const pendingChecked = document.querySelectorAll('.pending-checkbox:checked').length;
        batchStatusBar.style.display = approvedChecked > 0 ? 'flex' : 'none';
        batchStatusBar.querySelector('#status-selected-count').textContent = `${approvedChecked} item(s) selected`;
        batchPendingStatusBar.style.display = pendingChecked > 0 ? 'flex' : 'none';
        batchPendingStatusBar.querySelector('#pending-status-selected-count').textContent = `${pendingChecked} item(s) selected`;
        const deleteCount = completedChecked + otherChecked;
        batchDeleteBar.style.display = deleteCount > 0 ? 'flex' : 'none';
        batchDeleteBar.querySelector('#delete-selected-count').textContent = `${deleteCount} item(s) selected`;
        allCheckboxes.forEach(cb => {
            const card = cb.closest('.order-card');
            if (card) {
                card.classList.toggle('selected', cb.checked && card.style.display !== 'none');
                if (card.style.display === 'none') card.classList.remove('selected');
            }
        });
    }
    selectAllCheckboxes.forEach(sa => {
        sa.addEventListener('change', () => {
            const clickedSection = sa.dataset.section;
            const clickedGroupClass = `${clickedSection}-checkbox`;
            document.querySelectorAll(`.${clickedGroupClass}`).forEach(cb => {
                const card = cb.closest('.order-card');
                if (card && card.style.display !== 'none') {
                    cb.checked = sa.checked;
                } else if (sa.checked === false) {
                    cb.checked = false;
                }
            });
            if (sa.checked) {
                allCheckboxes.forEach(cb => {
                    if (!cb.classList.contains(clickedGroupClass)) {
                        cb.checked = false;
                    }
                });
                selectAllCheckboxes.forEach(otherSA => {
                    if (otherSA !== sa) {
                        otherSA.checked = false;
                    }
                });
            }
            updateActionBars();
        });
    });
    function handleExclusiveSelection(e) {
        const clickedCheckbox = e.currentTarget;
        let clickedGroup = null;
        if (clickedCheckbox.classList.contains('approved-checkbox')) clickedGroup = 'approved-checkbox';
        else if (clickedCheckbox.classList.contains('pending-checkbox')) clickedGroup = 'pending-checkbox';
        else if (clickedCheckbox.classList.contains('completed-checkbox')) clickedGroup = 'completed-checkbox';
        else if (clickedCheckbox.classList.contains('other-checkbox')) clickedGroup = 'other-checkbox';
        if (!clickedCheckbox.checked || !clickedGroup) {
            updateActionBars();
            return; 
        }
        allCheckboxes.forEach(cb => {
            if (cb === clickedCheckbox) return;
            let cbGroup = null;
            if (cb.classList.contains('approved-checkbox')) cbGroup = 'approved-checkbox';
            else if (cb.classList.contains('pending-checkbox')) cbGroup = 'pending-checkbox';
            else if (cb.classList.contains('completed-checkbox')) cbGroup = 'completed-checkbox';
            else if (cb.classList.contains('other-checkbox')) cbGroup = 'other-checkbox';
            if (cbGroup && cbGroup !== clickedGroup) {
                cb.checked = false;
            }
        });
        selectAllCheckboxes.forEach(sa => {
            const sectionGroup = `${sa.dataset.section}-checkbox`;
            if (sectionGroup !== clickedGroup) {
                sa.checked = false;
            }
        });
        updateActionBars();
    }
    allCheckboxes.forEach(cb => cb.addEventListener('change', handleExclusiveSelection));
    updateActionBars(); // Initial check

    // ==================================================================
    // == 3. ATTACH AJAX SUBMIT LISTENERS
    // ==================================================================

    /**
     * Helper for all fetch requests
     */
    function handleFetch(url, formData, button) {
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Processing...';

        return fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            return response.json();
        })
        .catch(error => {
            // This catch handles network errors *and* non-JSON responses (like a 500 error page)
            console.error('Fetch error:', error);
            showMessage(`A network or server error occurred: ${error.message}`, 'error');
            return null; // Return null to stop the .then() chain
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
    
    // --- BATCH STATUS UPDATE (Approved Section) ---
    batchStatusUpdateBtn.addEventListener('click', () => {
        const selectedIds = Array.from(document.querySelectorAll('.approved-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) return;

        const formData = new FormData(batchStatusForm);
        formData.set('order_ids', selectedIds.join(','));
        formData.set('status', document.getElementById('batch-status-select').value);
        
        const url = batchStatusForm.getAttribute('action');

        handleFetch(url, formData, batchStatusUpdateBtn).then(data => {
            if (data && data.success) {
                showMessage(data.message, 'success');
                data.orders.forEach(order => {
                    moveOrderCard(order.id, order.status);
                });
                updateActionBars(); // This will uncheck and hide the bar
            } else if (data) {
                showMessage(data.error || 'An unknown error occurred.', 'error');
            }
        });
    });
    
    // --- BATCH STATUS UPDATE (Pending Section) ---
    batchPendingStatusUpdateBtn.addEventListener('click', () => {
        const selectedIds = Array.from(document.querySelectorAll('.pending-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) return;

        const formData = new FormData(batchPendingStatusForm);
        formData.set('order_ids', selectedIds.join(','));
        formData.set('status', document.getElementById('batch-pending-status-select').value);
        
        const url = batchPendingStatusForm.getAttribute('action');

        handleFetch(url, formData, batchPendingStatusUpdateBtn).then(data => {
            if (data && data.success) {
                showMessage(data.message, 'success');
                data.orders.forEach(order => {
                    moveOrderCard(order.id, order.status);
                });
                updateActionBars();
            } else if (data) {
                showMessage(data.error || 'An unknown error occurred.', 'error');
            }
        });
    });

    // --- BATCH DELETE (Trigger Modal) ---
    batchDeleteBtn.addEventListener('click', () => {
        const selectedIds = Array.from(document.querySelectorAll('.completed-checkbox:checked, .other-checkbox:checked')).map(cb => cb.value);
        const count = selectedIds.length;
        if (count > 0) {
            batchDeleteConfirmModal.querySelector('#batch-delete-count').textContent = count;
            confirmBatchDeleteBtn.dataset.ids = selectedIds.join(',');
            openModal(batchDeleteConfirmModal);
        }
    });

    // --- BATCH DELETE (Confirm & Fetch) ---
    confirmBatchDeleteBtn.addEventListener('click', function() {
        const idsToSubmit = this.dataset.ids;
        if (!idsToSubmit) return;

        const formData = new FormData(batchDeleteForm);
        formData.set('order_ids', idsToSubmit);
        
        const url = batchDeleteForm.getAttribute('action');

        handleFetch(url, formData, this).then(data => {
            if (data && data.success) {
                showMessage(data.message, 'success');
                closeModal(batchDeleteConfirmModal);
                data.order_ids.forEach(id => {
                    removeOrderCard(id);
                });
                updateActionBars(); // This will hide the bar
            } else if (data) {
                showMessage(data.error || 'An unknown error occurred.', 'error');
            }
        });
    });
    
    // --- SINGLE STATUS UPDATE (Full Form) ---
    singleStatusForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const url = this.action;
        const button = this.querySelector('button[type="submit"]');

        handleFetch(url, formData, button).then(data => {
            if (data && data.success) {
                showMessage(data.message, 'success');
                closeModal(detailsModal);
                data.orders.forEach(order => { // Will only be one
                    moveOrderCard(order.id, order.status);
                });
            } else if (data) {
                showMessage(data.error || 'An unknown error occurred.', 'error');
            }
        });
    });
    
    // --- SINGLE STATUS UPDATE (Pending Form) ---
    singlePendingStatusForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const url = this.action;
        const button = this.querySelector('button[type="submit"]');

        handleFetch(url, formData, button).then(data => {
            if (data && data.success) {
                showMessage(data.message, 'success');
                closeModal(detailsModal);
                data.orders.forEach(order => { // Will only be one
                    moveOrderCard(order.id, order.status);
                });
            } else if (data) {
                showMessage(data.error || 'An unknown error occurred.', 'error');
            }
        });
    });

    // --- SINGLE DELETE (Trigger Modal) ---
    openSingleDeleteModalBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const actionUrl = singleDeleteForm.action; 
        const orderId = actionUrl.split('/delete-order/')[1].replace('/', '');
        singleDeleteConfirmModal.querySelector('#single-delete-order-id').textContent = `#${orderId}`;
        // Pass the URL to the final confirm button
        confirmSingleDeleteBtn.dataset.url = actionUrl;
        openModal(singleDeleteConfirmModal);
    });

    // --- SINGLE DELETE (Confirm & Fetch) ---
    confirmSingleDeleteBtn.addEventListener('click', function() {
        const url = this.dataset.url;
        if (!url) return;

        // Create empty FormData just to work with our handleFetch helper
        const formData = new FormData(); 

        handleFetch(url, formData, this).then(data => {
            if (data && data.success) {
                showMessage(data.message, 'success');
                closeModal(singleDeleteConfirmModal);
                closeModal(detailsModal);
                removeOrderCard(data.order_id);
            } else if (data) {
                showMessage(data.error || 'An unknown error occurred.', 'error');
            }
        });
    });

});
</script>
{% endblock %}