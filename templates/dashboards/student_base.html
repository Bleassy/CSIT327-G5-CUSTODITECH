{% load static %}
{% load humanize %}<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page_title|default:'Dashboard' }} - CIT Wildcats Store</title>
    <link rel="stylesheet" href="{% static 'css/student_base.css' %}?v=1.3">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    {% block extra_css %}{% endblock %}

    </head>
    
    <body class="buyer-dashboard">

    <div class="loader-overlay" id="page-loader">
        <div class="loader-spinner"></div>
    </div>

    <header class="dashboard-header">
    <div class="header-left">
        <a class="logo {% if active_page == 'dashboard' %}active{% endif %}" href="{% url 'student_dashboard' %}"> 
            <span class="logo-icon"><i class="fa-solid fa-cat"></i></span>
            <span class="logo-text">CIT Wildcats Store</span>
        </a>
    </div>

    <div class="mobile-menu-wrapper">
        <nav class="main-nav">
            <a href="{% url 'student_dashboard' %}" class="nav-btn {% if active_page == 'dashboard' %}active{% endif %}"><i class="fa-solid fa-house"></i> Dashboard</a>
            <a href="{% url 'browse_products' %}" class="nav-btn {% if active_page == 'browse' %}active{% endif %}"><i class="fa-solid fa-store"></i> Browse Products</a>
            <a href="{% url 'my_reservations' %}" class="nav-btn {% if active_page == 'reservations' %}active{% endif %}"><i class="fa-solid fa-calendar-days"></i> My Reservations</a>
            <a href="{% url 'my_orders' %}" class="nav-btn {% if active_page == 'orders' %}active{% endif %}"><i class="fa-solid fa-box-archive"></i> My Orders</a>
        </nav>
        <div class="header-right header-right-mobile"> <a href="{% url 'student_profile' %}" class="student-name-link {% if active_page == 'profile' %}active{% endif %}">
                {% if profile.avatar_url %}
                    <img src="{{ profile.avatar_url }}" alt="Profile" class="header-avatar">
                {% else %}
                    <span class="header-avatar header-initials">
                        {{ profile.full_name|default:request.user.get_full_name|default:'U'|first|upper }}
                    </span>
                {% endif %}
                <span class="student-name-text">
                    Hello, <strong>{{ display_name|default:'Student' }}</strong>!
                </span>
            </a>
            <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
        </div>
    </div>
    
    <div class="header-controls-right">
        <div class="notification-bell-wrapper">
            <button type="button" 
                    class="notification-btn {% if active_page == 'notifications' %}active{% endif %}" 
                    id="notification-bell-btn" 
                    aria-label="Toggle notifications">
                <i class="fa-regular fa-bell"></i>
                {% if notification_count > 0 %}
                    <span class="notification-count">{{ notification_count }}</span>
                {% endif %}
            </button>
            
            <div class="notification-dropdown" id="notification-dropdown">
                <div class="dropdown-header">
                    <strong>Notifications</strong>
                    <div class="tabs" id="notification-tabs">
                        <button type="button" class="tab-btn active" data-tab="all">All</button>
                        <button type="button" class="tab-btn" data-tab="unread">Unread</button>
                    </div>
                </div>

                <div class="notification-list" id="notification-list">
                    {% for notification in notifications %}
                        
                        <button type="button" 
                                class="notification-item {% if not notification.is_read %}notification-unread{% endif %}" 
                                data-url="{% url 'mark_notification_read_and_redirect' notification.id %}"
                                data-read="{{ notification.is_read|yesno:'true,false' }}">
                            
                            <img src="{{ notification.products.image_url|default:'https://placehold.co/400x300/e0e7ff/3730a3?text=Item' }}" 
                                 alt="Product" class="notification-product-image">
                            
                            <div class="notification-content">
                                <p class="notification-message">{{ notification.message }}</p>
                                <span class="notification-time">{{ notification.created_at|timesince }} ago</span>
                            </div>

                            {% if not notification.is_read %}
                                <div class="unread-dot"></div>
                            {% endif %}
                        </button>

                    {% empty %}
                        <div class="empty-state">
                            <div class="empty-state-icon"><i class="fa-solid fa-check"></i></div>
                            <h3>All clear!</h3>
                            <p>You have no notifications right now.</p>
                        </div>
                    {% endfor %}

                    <div class="empty-state" id="dynamic-empty-state" style="display: none;">
                            <div class="empty-state-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                            <h3>No notifications found</h3>
                            <p>No notifications match this filter.</p>
                        </div>
                    </div>

                <div class="dropdown-footer">
                    <a href="{% url 'all_notifications' %}">View All Notifications</a>
                </div>
            </div>
            </div>

        <div class="header-right header-right-desktop"> <a href="{% url 'student_profile' %}" class="student-name-link {% if active_page == 'profile' %}active{% endif %}">
                {% if profile.avatar_url %}
                    <img src="{{ profile.avatar_url }}" alt="Profile" class="header-avatar">
                {% else %}
                    <span class="header-avatar header-initials">
                        {{ profile.full_name|default:request.user.get_full_name|default:'U'|first|upper }}
                    </span>
                {% endif %}
                <span class="student-name-text">
                    Hello, <strong>{{ display_name|default:'Student' }}</strong>!
                </span>
            </a>
            <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
        </div>
    
        <button class="hamburger-btn" aria-label="Toggle menu" aria-expanded="false">
            <span class="hamburger-icon">&equiv;</span>
        </button>
    </div></header>
    
    <div class="container">
        <ul class="messages" id="messages-container">
            {% if messages %}
                {% for message in messages %}
                    <li class="{{ message.tags }}">{{ message }}</li>
                {% endfor %}
            {% endif %}
        </ul>
        
        {% block content %}{% endblock %}
    </div>
    
    {% block extra_js %}{% endblock %}

    <script>
        // Helper function to get the CSRF token from cookies
        function getCsrfToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

    <script>
        // ===== Page Loader Logic =====
        const loader = document.getElementById('page-loader');
        if (loader) {
            window.addEventListener('pageshow', function() {
                loader.classList.remove('visible');
            });

            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');
                if (link) {
                    if (link.classList.contains('active')) {
                        e.preventDefault();
                        return;
                    }
                    if (link.target === '_blank') return;
                    if (link.href.startsWith(window.location.href + '#')) return;
                    if (link.href.startsWith('mailto:') || link.href.startsWith('tel:')) return;
                    if (link.closest('.pagination-container')) return;
                    
                    if (link.closest('.notification-dropdown')) {
                        loader.classList.add('visible');
                        return; 
                    }
                    if (e.target.closest('#notification-bell-btn')) return;
                    
                    // Filter for new tab buttons
                    if (e.target.closest('#notification-tabs')) return; 

                    if (e.ctrlKey || e.metaKey) return;
                    loader.classList.add('visible');
                }
            });
        }

        // Wait for the document to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Hamburger Menu Logic ---
            const hamburgerBtn = document.querySelector('.hamburger-btn');
            const header = document.querySelector('.dashboard-header');
            const body = document.body;
            if (hamburgerBtn && header && body) {
                hamburgerBtn.addEventListener('click', function() {
                    header.classList.toggle('menu-is-open');
                    body.classList.toggle('menu-is-open');
                    const isExpanded = header.classList.contains('menu-is-open');
                    hamburgerBtn.setAttribute('aria-expanded', isExpanded);
                    const icon = hamburgerBtn.querySelector('.hamburger-icon');
                    if (isExpanded) {
                        icon.innerHTML = '&times;'; // 'X' icon
                    } else {
                        icon.innerHTML = '&equiv;'; // 'â˜°' icon
                    }
                });
            }

            // --- Updated Notification Logic ---
            const bellBtn = document.getElementById('notification-bell-btn');
            const dropdown = document.getElementById('notification-dropdown');

            if (bellBtn && dropdown) {
                // Toggle dropdown on bell click
                bellBtn.addEventListener('click', function(e) {
                    if (bellBtn.classList.contains('active')) {
                        return;
                    }
                    e.stopPropagation(); 

                    const isOpening = !dropdown.classList.contains('visible');
                    dropdown.classList.toggle('visible');

                    // Close hamburger menu if it's open
                    if (isOpening && header.classList.contains('menu-is-open')) {
                            header.classList.remove('menu-is-open');
                            body.classList.remove('menu-is-open');
                            hamburgerBtn.setAttribute('aria-expanded', 'false');
                            hamburgerBtn.querySelector('.hamburger-icon').innerHTML = '&equiv;';
                        }
                    });

                // Close dropdown when clicking outside - enhanced for mobile
                document.addEventListener('click', function(e) {
                    if (dropdown.classList.contains('visible') && 
                        !dropdown.contains(e.target) && 
                        !bellBtn.contains(e.target)) {
                        dropdown.classList.remove('visible');
                    }
                });

                // Close dropdown on window resize (prevents layout issues)
                window.addEventListener('resize', function() {
                    if (window.innerWidth <= 992 && dropdown.classList.contains('visible')) {
                        dropdown.classList.remove('visible');
                    }
                });
            }

            // --- Click-to-Redirect Logic for notification buttons ---
            const notificationList = document.getElementById('notification-list');
            if (notificationList) {
                notificationList.addEventListener('click', function(e) {
                    const notificationItem = e.target.closest('.notification-item');
                    
                    if (notificationItem) {
                        const url = notificationItem.dataset.url;
                        if (!url) return;

                        if (loader) loader.classList.add('visible');

                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCsrfToken(),
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                window.location.href = "{% url 'my_orders' %}";
                            }
                        })
                        .catch(error => {
                            console.error('Error marking notification as read:', error);
                            window.location.href = "{% url 'my_orders' %}";
                        });
                    }
                });
            }

            // --- NEW: Tab switching logic for dropdown ---
            const notificationTabs = document.getElementById('notification-tabs');
            if (notificationList && notificationTabs) {
                notificationTabs.addEventListener('click', function(e) {
                    if (e.target.classList.contains('tab-btn')) {
                        // Stop the dropdown from closing
                        e.stopPropagation();
                        
                        // Update active tab button
                        notificationTabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        const currentTab = e.target.dataset.tab;
                        
                        // Filter the list
                        notificationList.querySelectorAll('.notification-item, .empty-state').forEach(item => {
                            if (item.classList.contains('empty-state')) return;
                            
                            const isRead = item.dataset.read === 'true';
                            if (currentTab === 'all' || (currentTab === 'unread' && !isRead)) {
                                item.style.display = 'flex';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                        checkDropdownEmptyState();
                    }
                });
            }

            // --- NEW HELPER FUNCTION ---
        const dynamicEmptyState = document.getElementById('dynamic-empty-state');

        function checkDropdownEmptyState() {
            if (!notificationList || !dynamicEmptyState) return;

            // Find the "All Clear!" message
            const staticEmptyState = notificationList.querySelector('.empty-state:not(#dynamic-empty-state)');
            
            // If "All Clear!" is showing, don't do anything
            if (staticEmptyState && staticEmptyState.offsetParent !== null) {
                dynamicEmptyState.style.display = 'none';
                return;
            }

            // Count how many items are visible
            const visibleItems = notificationList.querySelectorAll('.notification-item:not([style*="display: none"])').length;

            if (visibleItems === 0) {
                // No items are visible, so show the dynamic "No notifications match" message
                dynamicEmptyState.style.display = 'block';
            } else {
                // Items are visible, so hide the dynamic message
                dynamicEmptyState.style.display = 'none';
            }
        }
        // --- END HELPER FUNCTION ---

        });
    </script>
    </body>
</html>