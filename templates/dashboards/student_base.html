{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ page_title|default:'Dashboard' }} - CIT Wildcats Store</title>
    <link rel="stylesheet" href="{% static 'css/student_base.css' %}?v=1.2">
    {% block extra_css %}{% endblock %}
</head>
<body class="buyer-dashboard">

    <div class="loader-overlay" id="page-loader">
        <div class="loader-spinner"></div>
    </div>

    <header class="dashboard-header">
    <div class="header-left">
        <a class="logo" href="{% url 'student_dashboard' %}"> <span class="logo-icon">üê±</span>
            <span class="logo-text">CIT Wildcats Store</span>
        </a>
    </div>

    <div class="mobile-menu-wrapper">
        <nav class="main-nav">
            <a href="{% url 'student_dashboard' %}" class="nav-btn {% if active_page == 'dashboard' %}active{% endif %}">üè† Dashboard</a>
            <a href="{% url 'browse_products' %}" class="nav-btn {% if active_page == 'browse' %}active{% endif %}">üõçÔ∏è Browse Products</a>
            <a href="{% url 'my_reservations' %}" class="nav-btn {% if active_page == 'reservations' %}active{% endif %}">üìÖ My Reservations</a>
            <a href="{% url 'my_orders' %}" class="nav-btn {% if active_page == 'orders' %}active{% endif %}">üì¶ My Orders</a>
        </nav>
        <div class="header-right">

            <div class="notification-bell-wrapper">
                <button type="button" 
            class="notification-btn {% if active_page == 'notifications' %}active{% endif %}" 
            id="notification-bell-btn" 
            aria-label="Toggle notifications">
        üîî
                    {% if notification_count > 0 %}
                        <span class="notification-count">{{ notification_count }}</span>
                    {% endif %}
                </button>
                <div class="notification-dropdown" id="notification-dropdown">
                    <div class="dropdown-header">
                        <strong>Notifications</strong>
                    </div>
                <div class="notification-list" id="notification-list">
                    {% for notification in notifications %}
                        
                        <button type="button" 
                                class="notification-item {% if not notification.is_read %}notification-unread{% endif %}" 
                                data-url="{% url 'mark_notification_read_and_redirect' notification.id %}">
                            
                            <p class="notification-message">{{ notification.message }}</p>
                            <span class="notification-time">{{ notification.created_at|timesince }} ago</span>
                        </button>

                    {% empty %}
                        <div class="notification-item empty">
                            <p>You have no new notifications.</p>
                        </div>
                    {% endfor %}
                </div>
                    <div class="dropdown-footer">
                        <a href="{% url 'all_notifications' %}">View All Notifications</a>
                    </div>
                </div>
            </div>
            <a href="{% url 'student_profile' %}" class="student-name-link {% if active_page == 'profile' %}active{% endif %}">
                {% if profile.avatar_url %}
                    <img src="{{ profile.avatar_url }}" alt="Profile" class="header-avatar">
                {% else %}
                    <span class="header-avatar header-initials">
                        {{ profile.full_name|default:request.user.get_full_name|default:'U'|first|upper }}
                    </span>
                {% endif %}
                <span class="student-name-text">
                    Hello, <strong>{{ display_name|default:'Student' }}</strong>!
                </span>
            </a>
            <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
        </div>
    </div>
    
    <button class="hamburger-btn" aria-label="Toggle menu" aria-expanded="false">
        <span class="hamburger-icon">&equiv;</span>
    </button>
</header>
    <div class="container">

        <ul class="messages" id="messages-container">
            {% if messages %}
                {% for message in messages %}
                    <li class="{{ message.tags }}">{{ message }}</li>
                {% endfor %}
            {% endif %}
        </ul>
        
        {% block content %}{% endblock %}
    </div>
    
    {% block extra_js %}{% endblock %}

    <script>
        // Helper function to get the CSRF token from cookies
        function getCsrfToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

    <script>
        // ===== Page Loader Logic =====
        const loader = document.getElementById('page-loader');
        if (loader) {
            // Hide loader on page "show" (for back/forward button)
            window.addEventListener('pageshow', function() {
                loader.classList.remove('visible');
            });

            // Show loader on link clicks
            document.addEventListener('click', function(e) {
                const link = e.target.closest('a');

                if (link) {
                    // --- Filters: Don't show loader for... ---
                    if (link.target === '_blank') return;
                    if (link.href.startsWith(window.location.href + '#')) return;
                    if (link.href.startsWith('mailto:') || link.href.startsWith('tel:')) return;
                    if (link.closest('.pagination-container')) return;
                    
                    // This logic is for the "View All" link in the footer
                    if (link.closest('.notification-dropdown')) {
                        loader.classList.add('visible');
                        return; // Let the link click proceed
                    }

                    if (e.target.closest('#notification-bell-btn')) return;

                    if (e.ctrlKey || e.metaKey) return;
                    
                    loader.classList.add('visible');
                }
            });
        }

        // Wait for the document to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- Hamburger Menu Logic ---
            const hamburgerBtn = document.querySelector('.hamburger-btn');
            const header = document.querySelector('.dashboard-header');
            const body = document.body;
            if (hamburgerBtn && header && body) {
                hamburgerBtn.addEventListener('click', function() {
                    header.classList.toggle('menu-is-open');
                    body.classList.toggle('menu-is-open');
                    const isExpanded = header.classList.contains('menu-is-open');
                    hamburgerBtn.setAttribute('aria-expanded', isExpanded);
                    const icon = hamburgerBtn.querySelector('.hamburger-icon');
                    if (isExpanded) {
                        icon.innerHTML = '&times;'; // 'X' icon
                    } else {
                        icon.innerHTML = '&equiv;'; // '‚ò∞' icon
                    }
                });
            }

            // --- MERGE: Updated Notification Logic ---
            const bellBtn = document.getElementById('notification-bell-btn');
            const dropdown = document.getElementById('notification-dropdown');

            if (bellBtn && dropdown) {
                // Toggle dropdown on bell click
                bellBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevents the 'document' click from closing it
                    dropdown.classList.toggle('visible');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (dropdown.classList.contains('visible') && !dropdown.contains(e.target)) {
                        dropdown.classList.remove('visible');
                    }
                });
            }

            // --- MERGE: Add Click-to-Redirect Logic for notification buttons ---
            const notificationList = document.getElementById('notification-list');
            if (notificationList) {
                notificationList.addEventListener('click', function(e) {
                    // Find the button that was clicked
                    const notificationItem = e.target.closest('.notification-item');
                    
                    if (notificationItem) {
                        const url = notificationItem.dataset.url;
                        if (!url) return;

                        // 1. Show the page loader immediately
                        if (loader) loader.classList.add('visible');

                        // 2. Call the "mark as read" function
                        fetch(url, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCsrfToken(),
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            // 3. Redirect to the URL from the response
                            // This happens *after* the database update is complete
                            if (data.redirect_url) {
                                window.location.href = data.redirect_url;
                            } else {
                                // Fallback if something went wrong
                                window.location.href = "{% url 'my_orders' %}";
                            }
                        })
                        .catch(error => {
                            console.error('Error marking notification as read:', error);
                            // Still redirect so the user isn't stuck
                            window.location.href = "{% url 'my_orders' %}";
                        });
                    }
                });
            }
            // --- END MERGE ---
        });
    </script>
    </body>
</html>