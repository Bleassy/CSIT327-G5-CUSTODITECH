{% extends 'dashboards/admin_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/manage_products.css' %}?v=1.4"> 
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Manage Products</h1>
    <button class="btn btn-add" id="add-product-btn"><i class="fa-solid fa-plus"></i> Add New Product</button>
</div>

<div class="search-filter-container">
    <select id="category-filter" class="category-filter-select">
        <option value="all">All Categories</option>
        {% for category in categories %}
            <option value="{{ category|lower }}">{{ category }}</option>
        {% endfor %}
    </select>
    <input type="search" id="product-search-input" class="search-input" 
           placeholder="Filter by name, category, or status...">
</div>

<form id="batch-action-form" method="POST" action="{% url 'batch_update_products' %}">
    {% csrf_token %}
    <input type="hidden" name="action" id="batch-action-input">
    <input type="hidden" name="product_ids" id="batch-product-ids-input">

    <div class="table-container">
        <table class="data-table product-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-checkbox"></th>
                    <th>Image</th>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="product-table-body">
                {% for product in products %}
                <tr class="product-row {% if not product.is_available %}unavailable-row{% elif product.stock_quantity < 10 and product.stock_quantity > 0 %}low-stock-row{% endif %}"
                    data-name="{{ product.name|lower }}"
                    data-category="{{ product.category|default:''|lower }}"
                    data-status="{% if product.stock_quantity < 10 and product.stock_quantity > 0 %}low stock{% elif product.is_available %}available{% else %}unavailable{% endif %}">
                    
                    <td><input type="checkbox" class="product-checkbox" value="{{ product.id }}"></td>
                    <td>
                        <img src="{{ product.image_url|default:'https://placehold.co/100x100/e0e7ff/3730a3?text=Item' }}" alt="{{ product.name }}" class="product-thumbnail">
                    </td>
                    <td>
                        <div class="product-details">
                            <strong class="product-table-name">{{ product.name }} {% if product.size %}- {{ product.size }}{% endif %}</strong>
                            <span class="product-table-desc">{{ product.description|truncatewords:10 }}</span>
                        </div>
                    </td>
                    <td>{{ product.category|default:'N/A' }}</td>
                    <td>₱{{ product.price|floatformat:2 }}</td>
                    <td>
                        {% if product.stock_quantity < 10 and product.stock_quantity > 0 %}
                            <span class="low-stock-icon"><i class="fa-solid fa-triangle-exclamation"></i></span> {{ product.stock_quantity }} pcs
                        {% else %}
                            {{ product.stock_quantity }} pcs
                        {% endif %}
                    </td>
                    <td>
                        {% if product.stock_quantity < 10 and product.stock_quantity > 0 %}
                            <span class="badge badge-low-stock">Low Stock</span>
                        {% elif product.is_available %}
                            <span class="badge badge-available">Available</span>
                        {% else %}
                            <span class="badge badge-unavailable">Unavailable</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-edit"
                                    data-id="{{ product.id }}"
                                    data-name="{{ product.name }}"
                                    data-description="{{ product.description }}"
                                    data-price="{{ product.price|floatformat:2 }}"
                                    data-stock="{{ product.stock_quantity }}"
                                    data-category="{{ product.category }}"
                                    data-size="{{ product.size|default:'' }}"
                                    data-is-available="{{ product.is_available|yesno:'true,false' }}"
                                    data-image-url="{{ product.image_url|default:'' }}">
                                Edit
                            </button>
                            <button type="button" class="btn btn-delete" data-id="{{ product.id }}" data-name="{{ product.name }}">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr id="initial-empty-row">
                    <td colspan="8" class="no-data-cell">
                        {% if search_query %}
                            No products found for "{{ search_query }}".
                        {% else %}
                            You haven't added any products yet. Click "Add New Product" to get started!
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                
                <tr id="no-results-row" style="display: none;">
                     <td colspan="8" class="no-data-cell">No products found matching your filter.</td>
                 </tr>
            </tbody>
        </table>
    </div>
</form>

<div id="batch-action-bar" class="batch-action-bar" style="display: none;">
    <span id="selected-count">0 items selected</span>
    <div class="batch-buttons">
        <button type="button" class="btn btn-batch" id="batch-edit-btn" disabled>Edit</button>
        <button type="button" class="btn btn-batch btn-danger" data-action="delete-selected">Delete Selected</button>
    </div>
</div>

<div id="add-product-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Product</h2>
            <span class="close-btn">&times;</span>
        </div>
        <form action="{% url 'add_product' %}" method="post" enctype="multipart/form-data" class="modal-form">
            {% csrf_token %}
            <div class="form-group">
                 <label>Product Name</label>
                 <input type="text" name="product-name" required>
             </div>
             <div class="form-group">
                 <label>Category</label>
                 <select name="product-category" class="category-select" required>
                     <option value="" disabled selected>Select a category</option>
                     <option value="Uniforms">Uniforms</option>
                     <option value="Accessories">Accessories</option>
                     <option value="Office & School Supplies">Office & School Supplies</option>
                     <option value="Equipment & Tools">Equipment & Tools</option>
                     <option value="Merchandise & Souvenirs">Merchandise & Souvenirs</option>
                 </select>
             </div>
             <div class="form-group size-selection" style="display: none;">
                 <label>Size</label>
                 <select name="product-size">
                     <option value="XS">XS</option>
                     <option value="S">S</option>
                     <option value="M">M</option>
                     <option value="L">L</option>
                     <option value="XL">XL</option>
                     <option value="XXL">XXL</option>
                 </select>
             </div>
             <div class="form-row">
                 <div class="form-group">
                     <label>Price (₱)</label>
                     <input type="number" name="product-price" step="0.01" min="0" required>
                 </div>
                 <div class="form-group">
                     <label>Stock Quantity</label>
                     <input type="number" name="stock-quantity" min="0" required>
                 </div>
             </div>
             <div class="form-group">
                 <label>Description</label>
                 <textarea name="product-description" rows="3" required></textarea>
             </div>
             <div class="form-group">
                 <label>Product Image</label>
                 <input type="file" name="product-image" accept="image/*" class="image-upload-input">
                 <img src="https://placehold.co/400x200/f1f5f9/64748b?text=Image+Preview" alt="Preview" class="image-preview">
             </div>
             
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </div>
        </form>
    </div>
</div>

<div id="edit-product-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Product</h2>
            <span class="close-btn">&times;</span>
        </div>
        <form id="edit-product-form" method="post" enctype="multipart/form-data" class="modal-form">
            {% csrf_token %}
            <div class="form-group">
                 <label>Product Name</label>
                 <input type="text" id="edit-product-name" name="product-name" required>
             </div>
             <div class="form-group">
                 <label>Category</label>
                 <select id="edit-product-category" name="product-category" class="category-select" required>
                     <option value="" disabled>Select a category</option>
                     <option value="Uniforms">Uniforms</option>
                     <option value="Accessories">Accessories</option>
                     <option value="Office & School Supplies">Office & School Supplies</option>
                     <option value="Equipment & Tools">Equipment & Tools</option>
                     <option value="Merchandise & Souvenirs">Merchandise & Souvenirs</option>
                 </select>
             </div>
             <div class="form-group size-selection" style="display: none;">
                 <label>Size</label>
                 <select id="edit-product-size" name="product-size">
                     <option value="XS">XS</option>
                     <option value="S">S</option>
                     <option value="M">M</option>
                     <option value="L">L</option>
                     <option value="XL">XL</option>
                     <option value="XXL">XXL</option>
                 </select>
             </div>
             <div class="form-row">
                 <div class="form-group">
                     <label>Price (₱)</label>
                     <input type="number" id="edit-product-price" name="product-price" step="0.01" min="0" required>
                 </div>
                 <div class="form-group">
                     <label>Stock Quantity</label>
                     <input type="number" id="edit-stock-quantity" name="stock-quantity" min="0" required>
                 </div>
             </div>
             <div class="form-group">
                 <label>Description</label>
                 <textarea id="edit-product-description" name="product-description" rows="3" required></textarea>
             </div>
             <div class="form-group">
                 <label>Product Image (Optional)</label>
                 <input type="file" name="product-image" accept="image/*" class="image-upload-input">
                 <input type="hidden" id="edit-current-image-url" name="current-image-url">
                 <img src="https://placehold.co/400x200/f1f5f9/64748b?text=Image+Preview" alt="Image Preview" class="image-preview">
             </div>
             
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Product</button>
            </div>
        </form>
    </div>
</div>

<div id="delete-confirm-modal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>Confirm Deletion</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete "<strong id="delete-product-name"></strong>"? This action cannot be undone.</p>
        </div>
        <form id="delete-product-form" method="post">
            {% csrf_token %}
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-delete">Yes, Delete</button>
            </div>
        </form>
    </div>
</div>

<div id="product-details-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Product Details</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-image-container">
                    <img id="details-product-image" src="" alt="Product Image" class="details-image">
                </div>
                <div class="details-info">
                    <h3 id="details-product-name"></h3>
                    <p id="details-product-description"></p>
                    <div class="details-grid">
                        <span>Category:</span> <strong id="details-category"></strong>
                        <span>Price:</span> <strong id="details-price"></strong>
                        <span>Stock:</span> <strong id="details-stock"></strong>
                        <span>Status:</span> <span id="details-status-badge" class="badge"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-edit" id="details-edit-btn">Edit</button>
            <button type="button" class="btn btn-delete" id="details-delete-btn">Delete</button>
        </div>
    </div>
</div>

<div id="batch-delete-confirm-modal" class="modal">
    <div class="modal-content modal-sm"> 
        <div class="modal-header">
            <h2>Confirm Batch Deletion</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to permanently delete <strong id="batch-delete-count">0</strong> product(s)?</p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-batch-delete-btn">Yes, Delete Selected</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // ==================================================================
    // GET ALL ELEMENTS
    // ==================================================================
    const addModal = document.getElementById('add-product-modal');
    const editModal = document.getElementById('edit-product-modal');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const detailsModal = document.getElementById('product-details-modal');
    const batchDeleteConfirmModal = document.getElementById('batch-delete-confirm-modal');
    const addProductForm = addModal?.querySelector('form');
    const editProductForm = document.getElementById('edit-product-form');
    const deleteProductForm = document.getElementById('delete-product-form');
    const batchActionForm = document.getElementById('batch-action-form');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const batchActionBar = document.getElementById('batch-action-bar');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchActionInput = document.getElementById('batch-action-input');
    const batchProductIdsInput = document.getElementById('batch-product-ids-input');
    const batchEditBtn = document.getElementById('batch-edit-btn');
    const confirmBatchDeleteBtn = document.getElementById('confirm-batch-delete-btn');
    const searchInput = document.getElementById('product-search-input');
    const categoryFilter = document.getElementById('category-filter');
    const tableBody = document.getElementById('product-table-body');
    const noResultsRow = document.getElementById('no-results-row');
    const initialEmptyRow = document.getElementById('initial-empty-row');
    const addProductBtn = document.getElementById('add-product-btn');
    const detailsEditBtn = document.getElementById('details-edit-btn');
    const detailsDeleteBtn = document.getElementById('details-delete-btn');


    // ==================================================================
    // DEFINE ALL HELPER FUNCTIONS
    // ==================================================================
    function showMessage(message, type = 'success') {
        const container = document.getElementById('message-container');
        if (!container) {
            console.error("Message container not found!");
            return;
        }

        const li = document.createElement('li');
        li.className = type; // 'success' or 'error'
        
        // Add an icon based on type to use the 'gap' in your CSS
        const icon = (type === 'success') ? '✅' : '❌';
        li.textContent = ` ${message}`; // Add a space for the icon
        
        const iconSpan = document.createElement('span');
        iconSpan.textContent = icon;
        li.prepend(iconSpan); // Add the icon at the beginning

        container.appendChild(li);

        // Auto-remove the message after 4 seconds
        setTimeout(() => {
            li.style.opacity = '0';
            setTimeout(() => {
                li.remove();
            }, 500); // Wait for fade out to complete
        }, 4000);
    }

    /**
     * Gets the CSRF token from the main batch form.
     * @returns {string} The CSRF token value.
     */
    function getCsrfToken() {
        return document.querySelector('#batch-action-form [name=csrfmiddlewaretoken]').value;
    }

    function createProductRow(product) {
        if (!tableBody) return;
        initialEmptyRow?.remove();
        noResultsRow?.remove();
        const name = product.name || '';
        const description = product.description || '';
        const category = product.category || 'N/A';
        const size = product.size || '';
        const price = parseFloat(product.price || 0).toFixed(2);
        const stock = parseInt(product.stock_quantity || 0);
        const isAvailable = product.is_available === true;
        const imageUrl = product.image_url || 'https://placehold.co/100x100/e0e7ff/3730a3?text=Item';
        let stockDisplay, statusDisplay, statusClass, dataStatus;
        if (!isAvailable) {
            stockDisplay = `${stock} pcs`;
            statusDisplay = `<span class="badge badge-unavailable">Unavailable</span>`;
            statusClass = 'unavailable-row';
            dataStatus = 'unavailable';
        } else if (stock < 10 && stock > 0) {
            stockDisplay = `<span class="low-stock-icon"><i class="fa-solid fa-triangle-exclamation"></i></span> ${stock} pcs`;
            statusDisplay = `<span class="badge badge-low-stock">Low Stock</span>`;
            statusClass = 'low-stock-row';
            dataStatus = 'low stock';
        } else {
            stockDisplay = `${stock} pcs`;
            statusDisplay = `<span class="badge badge-available">Available</span>`;
            statusClass = 'available-row';
            dataStatus = 'available';
        }
        const row = document.createElement('tr');
        row.className = `product-row ${statusClass}`;
        row.dataset.name = name.toLowerCase();
        row.dataset.category = category.toLowerCase();
        row.dataset.status = dataStatus;
        row.innerHTML = `
            <td><input type="checkbox" class="product-checkbox" value="${product.id}"></td>
            <td><img src="${imageUrl}" alt="${name}" class="product-thumbnail"></td>
            <td>
                <div class="product-details">
                    <strong class="product-table-name">${name} ${size ? '- ' + size : ''}</strong>
                    <span class="product-table-desc">${description.substring(0, 50)}...</span>
                </div>
            </td>
            <td>${category}</td>
            <td>₱${price}</td>
            <td>${stockDisplay}</td>
            <td>${statusDisplay}</td>
            <td>
                <div class="action-buttons">
                    <button type="button" class="btn btn-edit"
                        data-id="${product.id}" data-name="${name}" data-description="${description}"
                        data-price="${price}" data-stock="${stock}" data-category="${category}"
                        data-size="${size}" data-is-available="${isAvailable ? 'true' : 'false'}"
                        data-image-url="${product.image_url || ''}">
                        Edit
                    </button>
                    <button type="button" class="btn btn-delete" data-id="${product.id}" data-name="${name}">
                        Delete
                    </button>
                </div>
            </td>
        `;
        tableBody.prepend(row);
        addListenersToRow(row);
    }

    function updateProductRow(product) {
        const editBtn = document.querySelector(`.btn-edit[data-id="${product.id}"]`);
        if (!editBtn) return;
        const row = editBtn.closest('tr.product-row');
        if (!row) return;
        const name = product.name || '';
        const description = product.description || '';
        const category = product.category || 'N/A';
        const size = product.size || '';
        const price = parseFloat(product.price || 0).toFixed(2);
        const stock = parseInt(product.stock_quantity || 0);
        const isAvailable = product.is_available === true;
        const imageUrl = product.image_url || 'https://placehold.co/100x100/e0e7ff/3730a3?text=Item';
        let stockDisplay, statusDisplay, statusClass, dataStatus;
        if (!isAvailable) {
            stockDisplay = `${stock} pcs`;
            statusDisplay = `<span class="badge badge-unavailable">Unavailable</span>`;
            statusClass = 'unavailable-row';
            dataStatus = 'unavailable';
        } else if (stock < 10 && stock > 0) {
            stockDisplay = `<span class="low-stock-icon"><i class="fa-solid fa-triangle-exclamation"></i></span> ${stock} pcs`;
            statusDisplay = `<span class="badge badge-low-stock">Low Stock</span>`;
            statusClass = 'low-stock-row';
            dataStatus = 'low stock';
        } else {
            stockDisplay = `${stock} pcs`;
            statusDisplay = `<span class="badge badge-available">Available</span>`;
            statusClass = 'available-row';
            dataStatus = 'available';
        }
        row.dataset.name = name.toLowerCase();
        row.dataset.category = category.toLowerCase();
        row.dataset.status = dataStatus;
        row.className = `product-row ${statusClass}`;
        row.querySelector('.product-thumbnail').src = imageUrl;
        row.querySelector('.product-thumbnail').alt = name;
        row.querySelector('.product-table-name').textContent = `${name} ${size ? '- ' + size : ''}`;
        row.querySelector('.product-table-desc').textContent = `${description.substring(0, 50)}...`;
        row.querySelector('td:nth-child(4)').textContent = category;
        row.querySelector('td:nth-child(5)').textContent = `₱${price}`;
        row.querySelector('td:nth-child(6)').innerHTML = stockDisplay;
        row.querySelector('td:nth-child(7)').innerHTML = statusDisplay;
        const newEditBtn = row.querySelector('.btn-edit');
        newEditBtn.dataset.name = name;
        newEditBtn.dataset.description = description;
        newEditBtn.dataset.price = price;
        newEditBtn.dataset.stock = stock;
        newEditBtn.dataset.category = category;
        newEditBtn.dataset.size = size;
        newEditBtn.dataset.isAvailable = isAvailable ? 'true' : 'false';
        newEditBtn.dataset.imageUrl = product.image_url || '';
        row.querySelector('.btn-delete').dataset.name = name;
    }
    
    function addListenersToRow(row) {
        row.addEventListener('click', (event) => {
            if (event.target.tagName === 'INPUT' || event.target.closest('button')) { return; }
            const editButton = row.querySelector('.btn-edit');
            if (editButton && detailsModal) {
                const data = editButton.dataset;
                detailsModal.querySelector('#details-product-image').src = row.querySelector('.product-thumbnail')?.src || '';
                detailsModal.querySelector('#details-product-name').textContent = data.name || '';
                detailsModal.querySelector('#details-product-description').textContent = data.description || '';
                detailsModal.querySelector('#details-category').textContent = data.category || 'N/A';
                detailsModal.querySelector('#details-price').textContent = `₱${data.price || '0.00'}`;
                detailsModal.querySelector('#details-stock').textContent = `${data.stock || 0} pcs`;
                const statusBadge = detailsModal.querySelector('#details-status-badge');
                if (statusBadge) {
                    const stock = parseInt(data.stock || 0);
                    const isAvailable = data.isAvailable === 'true';
                    if (!isAvailable) { statusBadge.className = 'badge badge-unavailable'; statusBadge.textContent = 'Unavailable'; }
                    else if (stock > 0 && stock < 10) { statusBadge.className = 'badge badge-low-stock'; statusBadge.textContent = 'Low Stock'; }
                    else { statusBadge.className = 'badge badge-available'; statusBadge.textContent = 'Available'; }
                }
                detailsModal.sourceEditBtn = editButton;
                detailsModal.sourceDeleteBtn = row.querySelector('.btn-delete');
                openModal(detailsModal);
            }
        });
        const editBtn = row.querySelector('.btn-edit');
        if (editBtn) {
            editBtn.addEventListener('click', () => {
                const data = editBtn.dataset;
                if (!editModal || !editProductForm) return;
                editProductForm.action = `/dashboard/admin/edit-product/${data.id}/`;
                editProductForm.querySelector('#edit-product-name').value = data.name || '';
                editProductForm.querySelector('#edit-product-category').value = data.category || '';
                editProductForm.querySelector('#edit-product-description').value = data.description || '';
                editProductForm.querySelector('#edit-product-price').value = data.price || '0.00';
                editProductForm.querySelector('#edit-stock-quantity').value = data.stock || '0';
                const imagePreview = editProductForm.querySelector('.image-preview');
                const currentImageUrlInput = editProductForm.querySelector('#edit-current-image-url');
                const imageFileInput = editProductForm.querySelector('.image-upload-input');
                if (imageFileInput) imageFileInput.value = '';
                if (currentImageUrlInput) currentImageUrlInput.value = data.imageUrl || '';
                if (imagePreview) {
                    imagePreview.src = data.imageUrl || 'https://placehold.co/400x200/f1f5f9/64748b?text=No+Current+Image';
                    imagePreview.style.display = 'block';
                }
                const sizeSelect = editProductForm.querySelector('#edit-product-size');
                const sizeContainer = sizeSelect?.closest('.size-selection');
                if (sizeContainer && sizeSelect) {
                    if (data.category === 'Uniforms') {
                        sizeContainer.style.display = 'block';
                        sizeSelect.value = data.size || 'XS';
                    } else {
                        sizeContainer.style.display = 'none';
                    }
                }
                const isAvailableCheckbox = editProductForm.querySelector('#edit-is-available');
                if (isAvailableCheckbox) isAvailableCheckbox.checked = data.isAvailable === 'true';
                openModal(editModal);
            });
        }
        const deleteBtn = row.querySelector('.btn-delete');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', () => {
                const productId = deleteBtn.dataset.id;
                const productName = deleteBtn.dataset.name;
                if (productId && deleteModal) {
                    deleteModal.querySelector('#delete-product-name').textContent = productName || 'this product';
                    if (deleteProductForm) deleteProductForm.action = `/dashboard/admin/delete-product/${productId}/`;
                    openModal(deleteModal);
                }
            });
        }
        const checkbox = row.querySelector('.product-checkbox');
        if (checkbox) {
            checkbox.addEventListener('change', (event) => {
                event.stopPropagation();
                if (!checkbox.checked && selectAllCheckbox) selectAllCheckbox.checked = false;
                updateBatchActionBar();
            });
        }
    }

    const openModal = (modal) => { if(modal) modal.style.display = 'block'; };
    const closeModal = (modal) => { if(modal) modal.style.display = 'none'; };

    function updateBatchActionBar() {
        const selectedCheckboxes = Array.from(
            document.querySelectorAll('.product-checkbox:checked')
        ).filter(cb => {
            const row = cb.closest('tr');
            // Check if the row exists and its display style is not 'none'
            return row && row.style.display !== 'none';
        });
        const count = selectedCheckboxes.length;
        if (batchActionBar) {
            batchActionBar.style.display = count > 0 ? 'flex' : 'none';
            if(selectedCountSpan) selectedCountSpan.textContent = `${count} item${count > 1 ? 's' : ''} selected`;
        }
        if (batchEditBtn) batchEditBtn.disabled = (count !== 1);
        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
            checkbox.closest('tr')?.classList.toggle('row-selected', checkbox.checked);
        });
    }

    function filterProducts() {
        if (!searchInput || !noResultsRow || !categoryFilter) { return; }

        // Get values from BOTH inputs
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedCategory = categoryFilter.value.toLowerCase();

        let visibleRowCount = 0;
        const currentProductRows = document.querySelectorAll('#product-table-body tr.product-row');
        
        currentProductRows.forEach(row => {
            const productName = row.dataset.name || '';
            const category = row.dataset.category || '';
            const status = row.dataset.status || '';

            const categoryMatch = (selectedCategory === 'all') || (category === selectedCategory);

            const searchMatch = productName.includes(searchTerm) || 
                               category.includes(searchTerm) || 
                               status.includes(searchTerm);
            
            const rowMatches = categoryMatch && searchMatch;

            row.style.display = rowMatches ? '' : 'none';
            if (rowMatches) visibleRowCount++;
        });

        if (noResultsRow) noResultsRow.style.display = (visibleRowCount === 0 && currentProductRows.length > 0) ? '' : 'none';
        if (initialEmptyRow) {
            initialEmptyRow.style.display = (currentProductRows.length === 0 && searchTerm.length === 0) ? '' : 'none';
        }
    }


    // ==================================================================
    // ATTACH EVENT LISTENERS
    // ==================================================================

    if (searchInput) {
        searchInput.addEventListener('input', filterProducts);
    }
    if (categoryFilter) { 
        categoryFilter.addEventListener('change', filterProducts);
    }

    filterProducts(); 

    document.querySelectorAll('.data-table tbody tr.product-row').forEach(row => {
        addListenersToRow(row);
    });

    if (detailsEditBtn) { detailsEditBtn.addEventListener('click', () => { if (detailsModal?.sourceEditBtn) { closeModal(detailsModal); detailsModal.sourceEditBtn.click(); } }); }
    if (detailsDeleteBtn) { detailsDeleteBtn.addEventListener('click', () => { if (detailsModal?.sourceDeleteBtn) { closeModal(detailsModal); detailsModal.sourceDeleteBtn.click(); } }); }

    if (addProductBtn) {
        addProductBtn.addEventListener('click', () => {
            if (!addProductForm) return;
            addProductForm.reset();
            const preview = addProductForm.querySelector('.image-preview');
            if(preview) preview.src = 'https://placehold.co/400x200/f1f5f9/64748b?text=Image+Preview';
            const sizeField = addProductForm.querySelector('.size-selection');
            if (sizeField) sizeField.style.display = 'none';
            openModal(addModal);
        });
    }

    if (batchEditBtn) { batchEditBtn.addEventListener('click', () => { document.querySelector('.product-checkbox:checked')?.closest('tr')?.querySelector('.btn-edit')?.click(); }); }

    document.querySelectorAll('.close-btn, .cancel-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal');
            if(modal) closeModal(modal);
        });
    });
    
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal') && event.target.style.display !== 'none') {
            closeModal(event.target);
        }
    });

    document.querySelectorAll('.category-select').forEach(select => {
        select.addEventListener('change', (event) => {
            const sizeField = event.target.closest('.modal-content')?.querySelector('.size-selection');
            if (sizeField) sizeField.style.display = (event.target.value === 'Uniforms') ? 'block' : 'none';
        });
        if (select.closest('#edit-product-modal')) select.dispatchEvent(new Event('change'));
    });

    document.querySelectorAll('.image-upload-input').forEach(input => {
        const preview = input.closest('.form-group')?.querySelector('.image-preview');
        if (preview) {
            input.addEventListener('change', (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    preview.src = URL.createObjectURL(file);
                    preview.style.display = 'block';
                    preview.onload = () => URL.revokeObjectURL(preview.src);
                }
            });
        }
    });

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            document.querySelectorAll('.product-checkbox').forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked; 
            });
            updateBatchActionBar();
        });
    }

    document.querySelectorAll('.btn-batch[data-action="delete-selected"]').forEach(button => {
        button.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            const count = selectedIds.length;
            if (count === 0) { showMessage('Please select at least one product.', 'error'); return; }
            if (batchDeleteConfirmModal) {
                batchDeleteConfirmModal.querySelector('#batch-delete-count').textContent = count;
                const confirmBtn = batchDeleteConfirmModal.querySelector('#confirm-batch-delete-btn');
                if(confirmBtn) confirmBtn.dataset.ids = selectedIds.join(',');
                openModal(batchDeleteConfirmModal);
            } else { console.error("Batch delete confirmation modal not found!"); }
        });
    });

    // ==================================================================
    // AJAX FORM SUBMISSION HANDLERS
    // ==================================================================

    if (addProductForm) {
        addProductForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const url = form.action;
            const modal = form.closest('.modal');
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnOriginalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';
            
            fetch(url, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    //Use showMessage
                    showMessage(data.message, 'success');
                    closeModal(modal);
                    form.reset();
                    createProductRow(data.product);
                    filterProducts();
                    updateBatchActionBar();
                } else {
                    //Use showMessage
                    showMessage(data.error || 'An unknown error occurred.', 'error');
                }
            })
            .catch(error => {
                console.error('Error during fetch or .then() processing:', error);
                //Use showMessage
                showMessage(`An error occurred: ${error.message}`, 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = btnOriginalText;
            });
        });
    }
    
    if (editProductForm) {
        editProductForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const url = form.action;
            const modal = form.closest('.modal');
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnOriginalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';
            
            fetch(url, {
                method: 'POST',
                body: new FormData(form),
                headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                
                    showMessage(data.message, 'success');
                    closeModal(modal);
                    updateProductRow(data.product);
                    filterProducts();
                    
                        const updatedCheckbox = document.querySelector(`.product-checkbox[value="${data.product.id}"]`);
                        if (updatedCheckbox) {
                            updatedCheckbox.checked = false;
                        }
                    updateBatchActionBar();
                } else {
                   
                    showMessage(data.error || 'An unknown error occurred.', 'error');
                }
            })
            .catch(error => {
                console.error('Error during fetch or .then() processing:', error);
             
                showMessage(`An error occurred: ${error.message}`, 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = btnOriginalText;
            });
        });
    }

    if (deleteProductForm) {
        deleteProductForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const form = this;
            const url = form.action;
            const modal = form.closest('.modal');
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnOriginalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Deleting...';
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json' 
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                 
                    showMessage(data.message, 'success');
                    closeModal(modal);
                    const rowToRemove = document.querySelector(`.btn-delete[data-id="${data.product_id}"]`)?.closest('tr');
                    if (rowToRemove) {
                        rowToRemove.remove();
                    }
                    filterProducts();
                    updateBatchActionBar();
                } else {
                   
                    showMessage(data.error || 'An unknown error occurred.', 'error');
                }
            })
            .catch(error => {
                console.error('Error during fetch or .then() processing:', error);
             
                showMessage(`An error occurred: ${error.message}`, 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = btnOriginalText;
            });
        });
    }
    
    if (confirmBatchDeleteBtn) {
        confirmBatchDeleteBtn.addEventListener('click', function() {
            const button = this;
            const idsToSubmit = button.dataset.ids;
            if (!idsToSubmit) {
                console.error("No IDs found for batch delete.");
                closeModal(batchDeleteConfirmModal);
                return;
            }

            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Deleting...';
            
            const url = batchActionForm.getAttribute('action'); 
            const formData = new FormData();
            formData.append('action', 'delete-selected');
            formData.append('product_ids', idsToSubmit);

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                if (!response.ok) { throw new Error(`HTTP error! Status: ${response.status}`); }
                return response.json();
            })
            .then(data => {
                if (data.success) {
              
                    showMessage(data.message, 'success');
                    closeModal(batchDeleteConfirmModal);
                    
                    data.product_ids.forEach(id => {
                        const rowToRemove = document.querySelector(`.btn-delete[data-id="${id}"]`)?.closest('tr');
                        if (rowToRemove) {
                            rowToRemove.remove();
                        }
                    });
                    
                    filterProducts();
                    if(selectAllCheckbox) selectAllCheckbox.checked = false; 
                        updateBatchActionBar();
                } else {
                   
                    showMessage(data.error || 'An unknown error occurred.', 'error');
                }
            })
            .catch(error => {
                console.error('Batch Delete Fetch Error:', error);
            
                showMessage(`An error occurred: ${error.message}`, 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
               
            });
        });
    }
    
    updateBatchActionBar();

});
</script>
{% endblock %}