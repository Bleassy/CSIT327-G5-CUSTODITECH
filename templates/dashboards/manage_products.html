{% extends 'dashboards/admin_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/manage_products.css' %}?v=1.3">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Manage Products</h1>
    <button class="btn btn-add" id="add-product-btn">üì¶ Add New Product</button>
</div>

<div class="page-controls">
    <form method="GET" action="{% url 'manage_products' %}" class="search-form">
        <input type="text" name="search" class="search-input" placeholder="Search by product name or category..." value="{{ search_query }}">
        <button type="submit" class="btn search-btn">Search</button>
    </form>
</div>

<form id="batch-action-form" method="POST" action="{% url 'batch_update_products' %}">
    {% csrf_token %}
    <input type="hidden" name="action" id="batch-action-input">
    <input type="hidden" name="product_ids" id="batch-product-ids-input">

    <div class="table-container">
        <table class="data-table product-table">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-checkbox"></th>
                    <th>Image</th>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr class="{% if not product.is_available %}unavailable-row{% elif product.stock_quantity < 10 and product.stock_quantity > 0 %}low-stock-row{% endif %}">
                    <td><input type="checkbox" class="product-checkbox" value="{{ product.id }}"></td>
                    <td>
                        <img src="{{ product.image_url|default:'https://placehold.co/100x100/e0e7ff/3730a3?text=Item' }}" alt="{{ product.name }}" class="product-thumbnail">
                    </td>
                    <td>
                        <div class="product-details">
                            <strong class="product-table-name">{{ product.name }} {% if product.size %}- {{ product.size }}{% endif %}</strong>
                            <span class="product-table-desc">{{ product.description|truncatewords:10 }}</span>
                        </div>
                    </td>
                    <td>{{ product.category|default:'N/A' }}</td>
                    <td>‚Ç±{{ product.price|floatformat:2 }}</td>
                    <td>
                        {% if product.stock_quantity < 10 and product.stock_quantity > 0 %}
                            ‚ö†Ô∏è {{ product.stock_quantity }} pcs
                        {% else %}
                            {{ product.stock_quantity }} pcs
                        {% endif %}
                    </td>
                    <td>
                        {% if product.stock_quantity < 10 and product.stock_quantity > 0 %}
                            <span class="badge badge-low-stock">Low Stock</span>
                        {% elif product.is_available %}
                            <span class="badge badge-available">Available</span>
                        {% else %}
                            <span class="badge badge-unavailable">Unavailable</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-edit" 
                                    data-id="{{ product.id }}"
                                    data-name="{{ product.name }}"
                                    data-description="{{ product.description }}"
                                    data-price="{{ product.price|floatformat:2 }}"
                                    data-stock="{{ product.stock_quantity }}"
                                    data-category="{{ product.category }}"
                                    data-size="{{ product.size|default:'' }}"
                                    data-is-available="{{ product.is_available|yesno:'true,false' }}"
                                    data-image-url="{{ product.image_url|default:'' }}">
                                Edit
                            </button>
                            <button type="button" class="btn btn-delete" data-id="{{ product.id }}" data-name="{{ product.name }}">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="no-data-cell">
                        {% if search_query %}
                            No products found for "{{ search_query }}".
                        {% else %}
                            You haven't added any products yet. Click "Add New Product" to get started!
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</form>

<div id="batch-action-bar" class="batch-action-bar" style="display: none;">
    <span id="selected-count">0 items selected</span>
    <div class="batch-buttons">
        <button type="button" class="btn btn-batch" id="batch-edit-btn" disabled>Edit</button>
        <button type="button" class="btn btn-batch btn-danger" data-action="delete-selected">Delete Selected</button>
    </div>
</div>

<div id="add-product-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Product</h2>
            <span class="close-btn">&times;</span>
        </div>
        <form action="{% url 'add_product' %}" method="post" enctype="multipart/form-data" class="modal-form">
            {% csrf_token %}
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" name="product-name" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select name="product-category" class="category-select" required>
                    <option value="" disabled selected>Select a category</option>
                    <option value="Uniforms">Uniforms</option>
                    <option value="Accessories">Accessories</option>
                    <option value="Office & School Supplies">Office & School Supplies</option>
                    <option value="Equipment & Tools">Equipment & Tools</option>
                    <option value="Merchandise & Souvenirs">Merchandise & Souvenirs</option>
                </select>
            </div>
            <div class="form-group size-selection" style="display: none;">
                <label>Size</label>
                <select name="product-size">
                    <option value="XS">XS</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                    <option value="XXL">XXL</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Price (‚Ç±)</label>
                    <input type="number" name="product-price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Stock Quantity</label>
                    <input type="number" name="stock-quantity" min="0" required>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea name="product-description" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label>Product Image</label>
                <input type="file" name="product-image" accept="image/*" class="image-upload-input">
                <img src="https://placehold.co/400x200/f1f5f9/64748b?text=Image+Preview" alt="Preview" class="image-preview">
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" name="is_available" id="add-is-available" checked>
                <label for="add-is-available">Available for Students</label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </div>
        </form>
    </div>
</div>

<div id="edit-product-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Product</h2>
            <span class="close-btn">&times;</span>
        </div>
        <form id="edit-product-form" method="post" enctype="multipart/form-data" class="modal-form">
            {% csrf_token %}
            <div class="form-group">
                <label>Product Name</label>
                <input type="text" id="edit-product-name" name="product-name" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="edit-product-category" name="product-category" class="category-select" required>
                    <option value="" disabled>Select a category</option>
                    <option value="Uniforms">Uniforms</option>
                    <option value="Accessories">Accessories</option>
                    <option value="Office & School Supplies">Office & School Supplies</option>
                    <option value="Equipment & Tools">Equipment & Tools</option>
                    <option value="Merchandise & Souvenirs">Merchandise & Souvenirs</option>
                </select>
            </div>
            <div class="form-group size-selection" style="display: none;">
                <label>Size</label>
                <select id="edit-product-size" name="product-size">
                    <option value="XS">XS</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                    <option value="XXL">XXL</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Price (‚Ç±)</label>
                    <input type="number" id="edit-product-price" name="product-price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Stock Quantity</label>
                    <input type="number" id="edit-stock-quantity" name="stock-quantity" min="0" required>
                </div>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="edit-product-description" name="product-description" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label>Product Image (Optional)</label>
                <input type="file" name="product-image" accept="image/*" class="image-upload-input">
                <input type="hidden" id="edit-current-image-url" name="current-image-url">
                <img src="https://placehold.co/400x200/f1f5f9/64748b?text=Image+Preview" alt="Image Preview" class="image-preview">
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="edit-is-available" name="is_available">
                <label for="edit-is-available">Available for Students</label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Product</button>
            </div>
        </form>
    </div>
</div>

<div id="delete-confirm-modal" class="modal">
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>Confirm Deletion</h2>
            <span class="close-btn">&times;</span>
        </div>
        <p>Are you sure you want to delete "<strong id="delete-product-name"></strong>"? This action cannot be undone.</p>
        <form id="delete-product-form" method="post">
            {% csrf_token %}
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                <button type="submit" class="btn btn-delete">Yes, Delete</button>
            </div>
        </form>
    </div>
</div>

<div id="product-details-modal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Product Details</h2>
            <span class="close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-image-container">
                    <img id="details-product-image" src="" alt="Product Image" class="details-image">
                </div>
                <div class="details-info">
                    <h3 id="details-product-name"></h3>
                    <p id="details-product-description"></p>
                    <div class="details-grid">
                        <span>Category:</span> <strong id="details-category"></strong>
                        <span>Price:</span> <strong id="details-price"></strong>
                        <span>Stock:</span> <strong id="details-stock"></strong>
                        <span>Status:</span> <span id="details-status-badge" class="badge"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-edit" id="details-edit-btn">Edit</button>
            <button type="button" class="btn btn-delete" id="details-delete-btn">Delete</button>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. GET ALL ELEMENTS ---
    const addModal = document.getElementById('add-product-modal');
    const editModal = document.getElementById('edit-product-modal');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const detailsModal = document.getElementById('product-details-modal');
    
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const batchActionBar = document.getElementById('batch-action-bar');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchActionForm = document.getElementById('batch-action-form');
    const batchActionInput = document.getElementById('batch-action-input');
    const batchProductIdsInput = document.getElementById('batch-product-ids-input');
    const batchEditBtn = document.getElementById('batch-edit-btn');

    // --- 2. HELPER FUNCTIONS ---
    const openModal = (modal) => { if(modal) modal.style.display = 'block'; };
    const closeModal = (modal) => { if(modal) modal.style.display = 'none'; };

    function updateBatchActionBar() {
        const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
        const count = selectedCheckboxes.length;

        if (count > 0) {
            batchActionBar.style.display = 'flex';
            selectedCountSpan.textContent = `${count} item${count > 1 ? 's' : ''} selected`;
        } else {
            batchActionBar.style.display = 'none';
        }

        batchEditBtn.disabled = (count !== 1);

        productCheckboxes.forEach(checkbox => {
            checkbox.closest('tr').classList.toggle('row-selected', checkbox.checked);
        });
    }

    // --- 3. ATTACH EVENT LISTENERS ---

    // ‚úÖ START: NEW ROW CLICK LOGIC
    document.querySelectorAll('.data-table tbody tr').forEach(row => {
        if (!row.querySelector('.product-checkbox')) return; 

        row.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON' || event.target.tagName === 'A' || event.target.tagName === 'INPUT') {
                return;
            }
            
            // Populate and open the details modal
            const editButton = row.querySelector('.btn-edit');
            if (editButton) {
                const data = editButton.dataset;
                
                // Populate the modal with data
                document.getElementById('details-product-image').src = row.querySelector('.product-thumbnail').src;
                document.getElementById('details-product-name').textContent = data.name;
                document.getElementById('details-product-description').textContent = data.description;
                document.getElementById('details-category').textContent = data.category;
                document.getElementById('details-price').textContent = `‚Ç±${data.price}`;
                document.getElementById('details-stock').textContent = `${data.stock} pcs`;

                // Status badge logic
                const statusBadge = document.getElementById('details-status-badge');
                const stock = parseInt(data.stock);
                const isAvailable = data.isAvailable === 'true';

                if (!isAvailable) {
                    statusBadge.className = 'badge badge-unavailable';
                    statusBadge.textContent = 'Unavailable';
                } else if (stock > 0 && stock < 10) {
                    statusBadge.className = 'badge badge-low-stock';
                    statusBadge.textContent = 'Low Stock';
                } else {
                    statusBadge.className = 'badge badge-available';
                    statusBadge.textContent = 'Available';
                }
                
                // Store the original buttons on the modal itself for later use
                detailsModal.sourceEditBtn = editButton;
                detailsModal.sourceDeleteBtn = row.querySelector('.btn-delete');

                openModal(detailsModal);
            }
        });
    });
    // ‚úÖ END: NEW ROW CLICK LOGIC

    // ‚úÖ ADDED: Logic for buttons INSIDE the details modal
    document.getElementById('details-edit-btn').addEventListener('click', () => {
        if (detailsModal.sourceEditBtn) {
            closeModal(detailsModal);
            detailsModal.sourceEditBtn.click(); // Trigger the original edit button
        }
    });

    document.getElementById('details-delete-btn').addEventListener('click', () => {
        if (detailsModal.sourceDeleteBtn) {
            closeModal(detailsModal);
            detailsModal.sourceDeleteBtn.click(); // Trigger the original delete button
        }
    });

    // Open "Add Product" modal
    document.getElementById('add-product-btn').addEventListener('click', () => openModal(addModal));

    // Individual "Edit" buttons in each row (still needed for the modal logic)
    document.querySelectorAll('.product-table .btn-edit').forEach(btn => {
        btn.addEventListener('click', () => {
            const data = btn.dataset;
            const form = document.getElementById('edit-product-form');
            form.action = `/dashboard/admin/edit-product/${data.id}/`;
            document.getElementById('edit-product-name').value = data.name;
            const categorySelect = document.getElementById('edit-product-category');
            categorySelect.value = data.category || '';
            document.getElementById('edit-product-description').value = data.description;
            document.getElementById('edit-product-price').value = data.price;
            document.getElementById('edit-stock-quantity').value = data.stock;

            const imagePreview = form.querySelector('.image-preview');
            const currentImageUrlInput = document.getElementById('edit-current-image-url');
            const imageFileInput = form.querySelector('.image-upload-input');
            imageFileInput.value = ''; // Clear any previously selected file
            currentImageUrlInput.value = data.imageUrl || ''; // Store the old URL

            // Show the current image or a placeholder
            if (data.imageUrl) {
            imagePreview.src = data.imageUrl;
            imagePreview.style.display = 'block';
            } else {
            imagePreview.src = 'https://placehold.co/400x200/f1f5f9/64748b?text=No+Current+Image';
            imagePreview.style.display = 'block';
            }

            const sizeSelect = document.getElementById('edit-product-size');
            const sizeContainer = sizeSelect.closest('.size-selection');
            if (data.category === 'Uniforms') {
                sizeContainer.style.display = 'block';
                sizeSelect.value = data.size || 'XS';
            } else {
                sizeContainer.style.display = 'none';
            }
            document.getElementById('edit-is-available').checked = data.isAvailable === 'true';
            openModal(editModal);
        });
    });
    
    // Batch Edit button click
    batchEditBtn.addEventListener('click', () => {
        const selectedCheckbox = document.querySelector('.product-checkbox:checked');
        if (selectedCheckbox) {
            const originalEditButton = selectedCheckbox.closest('tr').querySelector('.btn-edit');
            if (originalEditButton) originalEditButton.click();
        }
    });

    // Individual "Delete" buttons in each row
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => {
            const productId = btn.dataset.id;
            const productName = btn.dataset.name;
            if (productId) {
                document.getElementById('delete-product-name').textContent = productName;
                const form = document.getElementById('delete-product-form');
                form.action = `/dashboard/admin/delete-product/${productId}/`;
                openModal(deleteModal);
            }
        });
    });

    // Generic modal close buttons and outside click
    document.querySelectorAll('.close-btn, .cancel-btn').forEach(btn => {
        btn.addEventListener('click', () => closeModal(btn.closest('.modal')));
    });
    window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) closeModal(event.target);
    });

    // Dynamic size field for category dropdowns
    document.querySelectorAll('.category-select').forEach(select => {
        select.addEventListener('change', (event) => {
            const modalContent = select.closest('.modal-content');
            const sizeField = modalContent.querySelector('.size-selection');
            if (sizeField) {
                sizeField.style.display = (event.target.value === 'Uniforms') ? 'block' : 'none';
            }
        });
    });

    // Image preview on file upload
    document.querySelectorAll('.image-upload-input').forEach(input => {
    // Find the preview image within the same form-group container
    const preview = input.closest('.form-group').querySelector('.image-preview');
    if (preview) {
        input.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block'; // Ensure it's visible
            }
        });
    }
});

    // Batch Action & Select All Logic
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', () => {
            productCheckboxes.forEach(checkbox => { checkbox.checked = selectAllCheckbox.checked; });
            updateBatchActionBar();
        });
    }

    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', (event) => {
            // Prevent the row click from firing when clicking the checkbox directly
            event.stopPropagation();
            if (!checkbox.checked) {
                if (selectAllCheckbox) selectAllCheckbox.checked = false;
            }
            updateBatchActionBar();
        });
    });

    document.querySelectorAll('.btn-batch[data-action="delete-selected"]').forEach(button => {
        button.addEventListener('click', () => {
            const action = button.dataset.action;
            const selectedIds = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return alert('Please select at least one product.');
            if (action === 'delete-selected' && !confirm(`Are you sure you want to delete ${selectedIds.length} product(s)?`)) return;
            batchActionInput.value = action;
            batchProductIdsInput.value = selectedIds.join(',');
            batchActionForm.submit();
        });
    });
});
</script>
{% endblock %}