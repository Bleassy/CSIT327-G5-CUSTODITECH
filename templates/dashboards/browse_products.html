{% extends 'dashboards/student_base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/browse_products.css' %}?v=2.4">
{% endblock %}

{% block content %}
<h1 class="welcome-title">Available Products ðŸ›’</h1>
             
{% if messages %}
    <ul class="messages">
        {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
        {% endfor %}
    </ul>
{% endif %}

<div class="product-grid">
    {% for product in products %}
    <div class="product-card">
        <div class="product-image-container">
            <img src="{{ product.image_url|default:'https://placehold.co/400x300/e0e7ff/3730a3?text=Item' }}" alt="{{ product.name }}" class="product-image">
            {% if product.stock_quantity == 0 %}
                <div class="stock-overlay out-of-stock">Out of Stock</div>
            {% elif product.stock_quantity < 10 %}
                 <div class="stock-overlay low-stock">Low Stock</div>
            {% endif %}
        </div>
        <div class="product-info">
            <h3 class="product-name">{{ product.name }}</h3>
            <p class="product-description">{{ product.description|truncatewords:15 }}</p>
            <div class="product-meta">
                <span class="product-price">â‚±{{ product.price|floatformat:2 }}</span>
                <span class="product-stock">{{ product.stock_quantity }} pcs available</span>
            </div>
        </div>
        <div class="product-actions">
            {% if product.stock_quantity > 0 %}
                <!-- âœ… UPDATED: Added data-price to this button -->
                <button class="btn btn-secondary add-to-cart-btn" 
                        data-id="{{ product.id }}"
                        data-name="{{ product.name }}"
                        data-stock="{{ product.stock_quantity }}"
                        data-price="{{ product.price }}"
                        data-image-url="{{ product.image_url }}">
                    Add to Cart
                </button>
                <button class="btn btn-primary buy-now-btn" 
                        data-id="{{ product.id }}"
                        data-name="{{ product.name }}"
                        data-stock="{{ product.stock_quantity }}"
                        data-price="{{ product.price }}"
                        data-image-url="{{ product.image_url }}">
                    Buy Now
                </button>
            {% else %}
                <!-- âœ… UPDATED: Added data-price to this button -->
                <button class="btn btn-primary reserve-item-btn"
                        data-id="{{ product.id }}"
                        data-name="{{ product.name }}"
                        data-price="{{ product.price }}"
                        data-image-url="{{ product.image_url }}">
                    Reserve Item
                </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- MODAL 1: Buy Now -->
<div id="buy-now-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Purchase</h2><span class="close-btn">&times;</span></div>
        <form action="{% url 'create_order' %}" method="post" class="modal-form">
            {% csrf_token %}
            <div class="modal-body">
                <input type="hidden" name="product_id" id="buy-product-id">
                <input type="hidden" name="deal_method" value="meet-up">
                <img src="" alt="Product Image" class="modal-product-image">
                <p class="item-name-modal">You are buying: <strong id="buy-product-name"></strong></p>
                <div class="form-group"><label for="buy-quantity">Quantity</label><input type="number" id="buy-quantity" name="quantity" value="1" min="1" required></div>
                <div class="price-summary"><span>Total Price:</span><strong id="total-price">â‚±0.00</strong></div>
                <div class="form-group"><label>Payment Method</label><div class="payment-options"><label><input type="radio" name="payment_method" value="cash" checked> Cash</label></div></div>
                <div class="info-note"><p>Please go to the Custodian Department within 3 days after confirming your product. If you fail to claim it within 3 days, your product will be forfeited.</p></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary cancel-btn">Cancel</button><button type="submit" class="btn btn-primary">Confirm Purchase</button></div>
        </form>
    </div>
</div>

<!-- MODAL 2: Add to Cart (In-Stock Reservation) -->
<div id="reservation-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Reservation</h2><span class="close-btn">&times;</span></div>
        <form action="{% url 'create_reservation' %}" method="post" class="modal-form">
            {% csrf_token %}
            <div class="modal-body">
                <input type="hidden" name="product_id" id="reserve-product-id">
                <input type="hidden" name="deal_method" value="meet-up">
                <img src="" alt="Product Image" class="modal-product-image">
                <p class="item-name-modal">You are reserving: <strong id="reserve-product-name"></strong></p>
                <div class="form-group"><label for="reserve-quantity">Quantity</label><input type="number" id="reserve-quantity" name="quantity" value="1" min="1" required></div>
                
                <!-- âœ… ADDED: Total Price Summary -->
                <div class="price-summary"><span>Total Price:</span><strong id="reserve-total-price">â‚±0.00</strong></div>

                <div class="form-group"><label>Payment Method</label><div class="payment-options"><label><input type="radio" name="payment_method" value="cash" checked> Cash on Pickup</label></div></div>
                <div class="date-info"><p><strong>Date Reserved:</strong> <span id="reserve-date"></span></p><p><strong>Reservation Expires:</strong> <span id="expiry-date"></span></p></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary cancel-btn">Cancel</button><button type="submit" class="btn btn-primary">Confirm Reservation</button></div>
        </form>
    </div>
</div>

<!-- MODAL 3: Reserve Item (Out-of-Stock) -->
<div id="backorder-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Reserve Out-of-Stock Item</h2><span class="close-btn">&times;</span></div>
        <form action="{% url 'create_reservation' %}" method="post" class="modal-form">
            {% csrf_token %}
            <div class="modal-body">
                <input type="hidden" name="product_id" id="backorder-product-id">
                <input type="hidden" name="deal_method" value="meet-up">
                <img src="" alt="Product Image" class="modal-product-image">
                <p class="item-name-modal">Reserving: <strong id="backorder-product-name"></strong></p>
                <p class="instructions">This item is currently out of stock. We will notify you when it becomes available.</p>
                <div class="form-group"><label for="backorder-quantity">Quantity</label><input type="number" id="backorder-quantity" name="quantity" value="1" min="1" required></div>
                
                <!-- âœ… ADDED: Total Price Summary -->
                <div class="price-summary"><span>Est. Total Price:</span><strong id="backorder-total-price">â‚±0.00</strong></div>

                <div class="form-group checkbox-group"><input type="checkbox" name="is_urgent" id="is-urgent"><label for="is-urgent">I need this badly.</label></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary cancel-btn">Cancel</button><button type="submit" class="btn btn-primary">Confirm Reservation</button></div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- General Modal Controls ---
    const closeModal = (modal) => { if (modal) modal.style.display = 'none'; };
    document.querySelectorAll('.close-btn, .cancel-btn').forEach(btn => btn.onclick = () => closeModal(btn.closest('.modal')));
    window.onclick = (event) => { if (event.target.classList.contains('modal')) closeModal(event.target); };

    // --- MODAL 1: Buy Now ---
    const buyModal = document.getElementById('buy-now-modal');
    document.querySelectorAll('.buy-now-btn').forEach(button => {
        button.onclick = () => {
            const data = button.dataset;
            buyModal.querySelector('#buy-product-id').value = data.id;
            buyModal.querySelector('.modal-product-image').src = data.imageUrl;
            buyModal.querySelector('#buy-product-name').textContent = data.name;
            const quantityInput = buyModal.querySelector('#buy-quantity');
            quantityInput.max = data.stock;
            const price = parseFloat(data.price);
            const totalPriceEl = buyModal.querySelector('#total-price');
            const updateTotal = () => {
                totalPriceEl.textContent = `â‚±${(price * (parseInt(quantityInput.value) || 0)).toFixed(2)}`;
            };
            quantityInput.oninput = updateTotal;
            updateTotal();
            buyModal.style.display = 'flex';
        };
    });

    // --- MODAL 2: Add to Cart (In-Stock Reservation) ---
    const reserveModal = document.getElementById('reservation-modal');
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.onclick = () => {
            const data = button.dataset;
            reserveModal.querySelector('#reserve-product-id').value = data.id;
            reserveModal.querySelector('.modal-product-image').src = data.imageUrl;
            reserveModal.querySelector('#reserve-product-name').textContent = data.name;
            const quantityInput = reserveModal.querySelector('#reserve-quantity');
            quantityInput.max = data.stock;
            
            // âœ… UPDATED: Add price calculation logic
            const price = parseFloat(data.price);
            const totalPriceEl = reserveModal.querySelector('#reserve-total-price');
            const updateTotal = () => {
                totalPriceEl.textContent = `â‚±${(price * (parseInt(quantityInput.value) || 0)).toFixed(2)}`;
            };
            quantityInput.oninput = updateTotal;
            updateTotal();

            // Date logic
            const today = new Date();
            const expiry = new Date();
            expiry.setDate(today.getDate() + 3);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            reserveModal.querySelector('#reserve-date').textContent = today.toLocaleDateString('en-US', options);
            reserveModal.querySelector('#expiry-date').textContent = expiry.toLocaleDateString('en-US', options);
            reserveModal.style.display = 'flex';
        };
    });

    // --- MODAL 3: Reserve Item (Out-of-Stock) ---
    const backorderModal = document.getElementById('backorder-modal');
    document.querySelectorAll('.reserve-item-btn').forEach(button => {
        button.onclick = () => {
            const data = button.dataset;
            backorderModal.querySelector('#backorder-product-id').value = data.id;
            backorderModal.querySelector('.modal-product-image').src = data.imageUrl;
            backorderModal.querySelector('#backorder-product-name').textContent = data.name;

            // âœ… UPDATED: Add price calculation logic
            const quantityInput = backorderModal.querySelector('#backorder-quantity');
            const price = parseFloat(data.price);
            const totalPriceEl = backorderModal.querySelector('#backorder-total-price');
            const updateTotal = () => {
                totalPriceEl.textContent = `â‚±${(price * (parseInt(quantityInput.value) || 0)).toFixed(2)}`;
            };
            quantityInput.oninput = updateTotal;
            updateTotal();
            
            backorderModal.style.display = 'flex';
        };
    });
});
</script>
{% endblock %}

