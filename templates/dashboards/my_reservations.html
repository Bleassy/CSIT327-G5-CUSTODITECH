{% extends 'dashboards/student_base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/my_reservations.css' %}?v=1.5">
{% endblock %}

{% block content %}
<h1 class="welcome-title"><i class="fa-solid fa-calendar-days"></i> My Reservations</h1>


<h2 class="section-title">Available for Pickup</h2>
{# Check if the list is NOT empty to show the grid #}
{% if reservations %}
    <div class="reservations-grid" id="pickup-grid">
        {% for item in reservations %}
            <div class="reservation-card"
                 data-id="{{ item.id }}"
                 data-name="{{ item.product_name }}"
                 data-size="{{ item.product_size|default:'' }}"
                 data-description="{{ item.product_description|default:'No description available.' }}"
                 data-image-url="{{ item.product_image_url|default:'https://placehold.co/400x300/e0e7ff/3730a3?text=Item' }}"
                 data-quantity="{{ item.quantity }}"
                 data-total-price="{% widthratio item.product_price 1 item.quantity as total %}{{ total|floatformat:2 }}"
                 data-created-at="{{ item.created_at|date:'M d, Y' }}"
                 data-expires-at="{{ item.expires_at|date:'M d, Y' }}">

                <img src="{{ item.product_image_url|default:'https://placehold.co/400x300/e0e7ff/3730a3?text=Item' }}" alt="{{ item.product_name }}" class="product-image">
                <div class="card-body">
                    <h3 class="product-name">{{ item.product_name }}{% if item.product_size %} - {{ item.product_size }}{% endif %}</h3>
                    <div class="details-grid">
                        <span>Quantity:</span><strong>{{ item.quantity }}</strong>
                        <span>Total Price:</span><strong>₱{% widthratio item.product_price 1 item.quantity as total %}{{ total|floatformat:2 }}</strong>
                        <span>Expires On:</span><strong>{{ item.expires_at|date:"M d, Y" }}</strong>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    {# Improved Empty State (hidden) #}
    <div class="empty-state-container no-items-message" id="no-pickup-message" style="display: none;">
        <div class="empty-state-icon"><i class="fa-solid fa-calendar-check"></i></div>
        <h3>You have no items for pickup</h3>
        <p>Ready to get started? Browse our products to find items to reserve.</p>
        <a href="{% url 'browse_products' %}" class="btn btn-primary-empty">Browse Products</a>
    </div>
{% else %}
    {# Improved Empty State (visible) #}
    <div class="reservations-grid" id="pickup-grid"></div> {# Empty grid for JS target #}
    <div class="empty-state-container no-items-message" id="no-pickup-message">
        <div class="empty-state-icon"><i class="fa-solid fa-calendar-check"></i></div>
        <h3>You have no items for pickup</h3>
        <p>Ready to get started? Browse our products to find items to reserve.</p>
        <a href="{% url 'browse_products' %}" class="btn btn-primary-empty">Browse Products</a>
    </div>
{% endif %}

<h2 class="section-title">Pending Backorders</h2>
{# Check if the list is NOT empty to show the grid #}
{% if backorders %}
    <div class="reservations-grid" id="backorder-grid">
         {% for item in backorders %}
            <div class="reservation-card backorder"
                 data-id="{{ item.id }}"
                 data-name="{{ item.product_name }}"
                 data-size="{{ item.product_size|default:'' }}"
                 data-description="{{ item.product_description|default:'No description available.' }}"
                 data-image-url="{{ item.product_image_url|default:'https://placehold.co/400x300/e0e7ff/3730a3?text=Item' }}"
                 data-quantity="{{ item.quantity }}"
                 data-total-price="{% widthratio item.product_price 1 item.quantity as total %}{{ total|floatformat:2 }}"
                 data-created-at="{{ item.created_at|date:'M d, Y' }}"
                 data-status="{% if item.product_stock_quantity >= item.quantity %}available{% else %}unavailable{% endif %}">

                <img src="{{ item.product_image_url|default:'https://placehold.co/400x300/e0e7ff/3730a3?text=Item' }}" alt="{{ item.product_name }}" class="product-image">
                <div class="card-body">
                    <h3 class="product-name">{{ item.product_name }}{% if item.product_size %} - {{ item.product_size }}{% endif %}</h3>
                    <div class="details-grid">
                        <span>Quantity:</span><strong>{{ item.quantity }}</strong>
                        <span>Est. Price:</span><strong>₱{% widthratio item.product_price 1 item.quantity as total %}{{ total|floatformat:2 }}</strong>
                        <span>Status:</span>
                        {% if item.product_stock_quantity >= item.quantity %}
                            <strong class="status-available">Now Available!</strong>
                        {% else %}
                            <strong class="status-unavailable">Out of Stock</strong>
                        {% endif %}
                    </div>
                </div>
            </div>
         {% endfor %}
    </div>
     {# Message is outside grid, hidden initially #}
    <div class="empty-state-container no-items-message" id="no-backorder-message" style="display: none;">
        <div class="empty-state-icon"><i class="fa-solid fa-box-open"></i></div>
        <h3>You have no pending backorders</h3>
        <p>You haven't reserved any out-of-stock items. All clear here!</p>
        <a href="{% url 'browse_products' %}" class="btn btn-primary-empty">Browse Products</a>
    </div>
{% else %}
    {# Improved Empty State (visible) #}
    <div class="reservations-grid" id="backorder-grid"></div> {# Empty grid for JS target #}
    <div class="empty-state-container no-items-message" id="no-backorder-message">
        <div class="empty-state-icon"><i class="fa-solid fa-box-open"></i></div>
        <h3>You have no pending backorders</h3>
        <p>You haven't reserved any out-of-stock items. All clear here!</p>
        <a href="{% url 'browse_products' %}" class="btn btn-primary-empty">Browse Products</a>
    </div>
{% endif %}

<div id="reservation-details-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Reservation Details</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-image-container">
                    <img id="res-details-image" src="" alt="Product Image" class="details-image">
                </div>
                <div class="details-info">
                    <h3 id="res-details-name" class="details-name"></h3>
                    <p id="res-details-description" class="details-description"></p>
                    <div class="details-summary-grid">
                        <span>Quantity:</span><strong id="res-details-quantity"></strong>
                        <span>Total Price:</span><strong id="res-details-total-price"></strong>
                        <span>Payment:</span><strong>Cash on Pickup</strong>
                        <span>Reserved On:</span><strong id="res-details-created-at"></strong>
                        <span>Expires On:</span><strong id="res-details-expires-at"></strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="res-cancel-btn">Cancel Reservation</button>
            <button type="button" class="btn btn-primary" id="res-checkout-btn">Check Out</button>
        </div>
    </div>
</div>

<div id="backorder-details-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Backorder Details</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-image-container">
                    <img id="bo-details-image" src="" alt="Product Image" class="details-image">
                </div>
                <div class="details-info">
                    <h3 id="bo-details-name" class="details-name"></h3>
                    <p id="bo-details-description" class="details-description"></p>
                    <div class="details-summary-grid">
                        <span>Quantity:</span><strong id="bo-details-quantity"></strong>
                        <span>Est. Price:</span><strong id="bo-details-total-price"></strong>
                        <span>Reserved On:</span><strong id="bo-details-created-at"></strong>
                        <span>Status:</span><strong id="bo-details-status"></strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger" id="bo-cancel-btn">Cancel Backorder</button>
            <button type="button" class="btn btn-primary" id="bo-checkout-btn" style="display: none;">Check Out</button>
        </div>
    </div>
</div>


<div id="checkout-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Check Out</h2><span class="close-btn">&times;</span></div>
        <form id="checkout-form" action="{% url 'checkout_reservation' %}" method="post" class="modal-form">
            {% csrf_token %}
            <div class="modal-body">
                <input type="hidden" name="reservation_id" id="checkout-reservation-id">
                <p>You are about to check out the following item:</p>
                <div class="summary">
                    <p><strong>Product:</strong> <span id="checkout-product-name"></span></p>
                    <p><strong>Quantity:</strong> <span id="checkout-quantity"></span></p>
                    <p><strong>Total Price:</strong> <span id="checkout-price"></span></p>
                </div>
                <p>This will convert your reservation into a formal order. Proceed?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
                <button type="submit" class="btn btn-primary">Confirm Check Out</button>
            </div>
        </form>
    </div>
</div>

<div id="cancel-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Cancellation</h2><span class="close-btn">&times;</span></div>
        <form id="cancel-form" method="post"> {% csrf_token %}
            <div class="modal-body">
                <p>Are you sure you want to cancel your reservation for:</p>
                <div class="summary">
                    <p><strong>Product:</strong> <span id="cancel-product-name"></span></p>
                </div>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-modal-btn">Keep Reservation</button>
                <button type="submit" class="btn btn-danger">Yes, Cancel It</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Get All Modals ---
    const detailsModal = document.getElementById('reservation-details-modal');
    const backorderModal = document.getElementById('backorder-details-modal');
    const checkoutModal = document.getElementById('checkout-modal');
    const cancelModal = document.getElementById('cancel-modal');

    // --- General Modal Controls ---
    const openModal = (modal) => modal.style.display = 'flex';
    const closeModal = (modal) => modal.style.display = 'none';
    document.querySelectorAll('.close-btn, .cancel-modal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal(btn.closest('.modal'));
        });
    });
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) closeModal(e.target);
    });

    // --- Logic for "Available for Pickup" cards ---
    document.querySelectorAll('.reservation-card:not(.backorder)').forEach(card => {
        card.addEventListener('click', () => {
            const data = card.dataset;
            const resNameEl = detailsModal.querySelector('#res-details-name');
            
            detailsModal.querySelector('#res-details-image').src = data.imageUrl;
            resNameEl.textContent = data.size ? `${data.name} - ${data.size}` : data.name;
            detailsModal.querySelector('#res-details-description').textContent = data.description;
            detailsModal.querySelector('#res-details-quantity').textContent = data.quantity;
            detailsModal.querySelector('#res-details-total-price').textContent = `₱${data.totalPrice}`;
            detailsModal.querySelector('#res-details-created-at').textContent = data.createdAt;
            detailsModal.querySelector('#res-details-expires-at').textContent = data.expiresAt;
            
            const checkoutBtn = detailsModal.querySelector('#res-checkout-btn');
            const cancelBtn = detailsModal.querySelector('#res-cancel-btn');
            Object.assign(checkoutBtn.dataset, data);
            Object.assign(cancelBtn.dataset, data);
            
            openModal(detailsModal);
        });
    });

    // --- Logic for "Pending Backorders" cards ---
    document.querySelectorAll('.reservation-card.backorder').forEach(card => {
        card.addEventListener('click', () => {
            const data = card.dataset;
            const boNameEl = backorderModal.querySelector('#bo-details-name');

            backorderModal.querySelector('#bo-details-image').src = data.imageUrl;
            boNameEl.textContent = data.size ? `${data.name} - ${data.size}` : data.name;
            backorderModal.querySelector('#bo-details-description').textContent = data.description;
            backorderModal.querySelector('#bo-details-quantity').textContent = data.quantity;
            backorderModal.querySelector('#bo-details-total-price').textContent = `₱${data.totalPrice}`;
            backorderModal.querySelector('#bo-details-created-at').textContent = data.createdAt;
            
            const statusEl = backorderModal.querySelector('#bo-details-status');
            const checkoutBtn = backorderModal.querySelector('#bo-checkout-btn');
            const cancelBtn = backorderModal.querySelector('#bo-cancel-btn');

            if (data.status === 'available') {
                statusEl.textContent = 'Now Available!';
                statusEl.className = 'status-available';
                checkoutBtn.style.display = 'inline-block';
            } else {
                statusEl.textContent = 'Out of Stock';
                statusEl.className = 'status-unavailable';
                checkoutBtn.style.display = 'none';
            }
            
            Object.assign(checkoutBtn.dataset, data);
            Object.assign(cancelBtn.dataset, data);

            openModal(backorderModal);
        });
    });

    // --- Reroute clicks from details modals to confirmation modals ---
    document.getElementById('res-checkout-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        closeModal(detailsModal);
        openCheckoutModal(this.dataset);
    });
    document.getElementById('res-cancel-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        closeModal(detailsModal);
        openCancelModal(this.dataset);
    });
    
    document.getElementById('bo-checkout-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        closeModal(backorderModal);
        openCheckoutModal(this.dataset);
    });
    document.getElementById('bo-cancel-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        closeModal(backorderModal);
        openCancelModal(this.dataset);
    });

    // --- Helper functions to open confirmation modals ---
    function openCheckoutModal(data) {
        const checkoutNameEl = checkoutModal.querySelector('#checkout-product-name');
        checkoutNameEl.textContent = data.size ? `${data.name} - ${data.size}` : data.name;

        checkoutModal.querySelector('#checkout-reservation-id').value = data.id;
        checkoutModal.querySelector('#checkout-quantity').textContent = data.quantity;
        checkoutModal.querySelector('#checkout-price').textContent = `₱${parseFloat(data.totalPrice).toFixed(2)}`;
        openModal(checkoutModal);
    }
    
    function openCancelModal(data) {
        const form = cancelModal.querySelector('#cancel-form');
        form.action = `/dashboard/student/cancel-reservation/${data.id}/`; 
        
        const cancelNameEl = cancelModal.querySelector('#cancel-product-name');
        cancelNameEl.textContent = data.size ? `${data.name} - ${data.size}` : data.name;

        openModal(cancelModal);
    }


// Helper function to show dynamic success/error messages
function showDynamicMessage(message, className = 'success') {
    const messagesContainer = document.getElementById('messages-container');
    if (!messagesContainer) {
        console.error("Message container not found!");
        return;
    }
    const li = document.createElement('li');
    li.className = className;
    li.textContent = message;
    messagesContainer.prepend(li);
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setTimeout(() => {
        li.style.opacity = '0';
        li.style.transition = 'opacity 0.5s ease';
        setTimeout(() => li.remove(), 500);
    }, 5000);
}

// Main function to handle AJAX form submission
function handleAjaxFormSubmit(form) {
    form.addEventListener('submit', async (event) => {
        event.preventDefault(); // Stop the page from reloading

        const submitButton = form.querySelector('button[type="submit"]');
        // Store original text OUTSIDE try/catch/finally
        const originalButtonText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';

        const formData = new FormData(form);
        const url = form.action;
        const method = form.method;
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch(url, {
                method: method,
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || 'An unknown error occurred.');
            }

            // --- Success ---
            closeModal(form.closest('.modal'));
            showDynamicMessage(data.message, 'success');

            // --- Card Removal Logic ---
            let reservationId = null;
            if (form.id === 'checkout-form') {
                reservationId = form.querySelector('#checkout-reservation-id')?.value;
            } else if (form.id === 'cancel-form') {
                const match = form.action.match(/cancel-reservation\/(\d+)\/?$/);
                if (match && match[1]) {
                    reservationId = match[1];
                }
            }
            console.log("Attempting to remove card with ID:", reservationId);
            if (reservationId) {
                const cardToRemove = document.querySelector(`.reservation-card[data-id="${reservationId}"]`);
                if (cardToRemove) {
                    cardToRemove.classList.add('removing');
                    setTimeout(() => {
                        const parentGrid = cardToRemove.parentElement;
                        cardToRemove.remove();
                        if (parentGrid && parentGrid.querySelectorAll('.reservation-card').length === 0) {
                             const noItemsMsg = parentGrid.nextElementSibling;
                             if (noItemsMsg && noItemsMsg.classList.contains('no-items-message')) {
                                 noItemsMsg.style.display = 'block';
                             } else {
                                 const p = document.createElement('p');
                                 p.className = 'no-items-message';
                                 p.textContent = parentGrid.previousElementSibling?.textContent.includes('Backorders')
                                     ? 'You have no pending backorders.'
                                     : 'You have no items reserved for pickup.';
                                 parentGrid.after(p);
                             }
                        }
                    }, 400);
                } else { console.warn("Card to remove not found in DOM for ID:", reservationId); }
            } else { console.error("Could not determine reservation ID to remove card."); }
            // --- End Card Removal ---

        } catch (error) {
            // --- Error ---
            console.error('Form submission error:', error);
            showDynamicMessage(`Error: ${error.message}`, 'error');
            // submitButton.disabled = false;
            // submitButton.textContent = originalButtonText;
        } finally {
            //
            console.log("Resetting button state."); // Debug log
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
        }
    });
}

// Attach the AJAX handler to your two confirmation forms
const checkoutForm = document.getElementById('checkout-form');
const cancelForm = document.getElementById('cancel-form');
if (checkoutForm) handleAjaxFormSubmit(checkoutForm);
if (cancelForm) handleAjaxFormSubmit(cancelForm);

});
</script>
{% endblock %}