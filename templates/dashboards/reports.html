{% extends 'dashboards/admin_base.html' %}
{% load static %}
{% load humanize %} 

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/reports.css' %}?v=1.8">
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>System Reports & KPIs</h1>
</div>

<div class="global-search-container search-container">
    <input type="search" id="global-report-search" class="search-input"
           placeholder="Search all reports (Inventory Overview, Reservation Statistics, Sales Performance, Unavailable Products, Low-stock, Activity Log...).">
</div>
<div class="searchable-section">
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon sales">üí∞</div>
            <div class="kpi-content">
                <h3>Total Sales (Completed)</h3>
                <div class="kpi-number">‚Ç±{{ kpi.total_sales|default:0|floatformat:2|intcomma }}</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon inventory"> üìà </div>
            <div class="kpi-content">
                <h3>Current Inventory Value</h3>
                <div class="kpi-number">‚Ç±{{ kpi.inventory_value|default:0|floatformat:2|intcomma }}</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon today">üìÖ</div>
            <div class="kpi-content">
                <h3>Total Orders (Today)</h3>
                <div class="kpi-number">{{ kpi.orders_today|default:0 }}</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon pending-res">‚è≥</div>
            <div class="kpi-content">
                <h3>Pending Reservations</h3>
                <div class="kpi-number">{{ kpi.pending_reservations|default:0 }}</div>
            </div>
        </div>
    </div>
</div> <div class="searchable-section">
    <div class="reports-grid">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon products">üì¶</div>
                <div class="stat-content"><h3>Total Products</h3><div class="stat-number">{{ total_products }}</div></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon orders">üõçÔ∏è</div>
                <div class="stat-content"><h3>Total Orders & Reservations</h3><div class="stat-number">{{ total_orders_reservations }}</div></div>
            </div>
        </div>
        <div class="chart-container">
            <h2>Order Status Overview</h2>
            <canvas id="orderStatusChart"></canvas>
        </div>
    </div>
</div> <div class="report-section searchable-section">
    <h2>Inventory Overview</h2>
    <div class="overview-grid"> 
        <div class="table-container">
            <h3>Stock by Category</h3>
            <table class="data-table small-text">
                <thead>
                    <tr><th>Category</th><th>Item Count</th><th>Total Value</th></tr>
                </thead>
                <tbody>
                    {% for item in inventory_overview.by_category|default_if_none:"[]" %}
                    <tr>
                        <td>{{ item.category }}</td>
                        <td>{{ item.item_count|intcomma }} pcs</td>
                        <td>‚Ç±{{ item.total_value|floatformat:2|intcomma }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="3" class="no-data-cell"><p>No inventory data available.</p></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-container">
            <h3>Top 5 Most Stocked Items</h3>
            <table class="data-table small-text">
                <thead>
                    <tr><th>Product Name</th><th>Stock</th></tr>
                </thead>
                <tbody>
                    {% for item in inventory_overview.most_stocked|default_if_none:"[]" %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td>{{ item.metric_value|floatformat:0|intcomma }} pcs</td> 
                    </tr>
                    {% empty %}
                     <tr><td colspan="2" class="no-data-cell"><p>No data.</p></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
         <div class="table-container">
            <h3>Top 5 Highest Value Items (Stock)</h3>
            <table class="data-table small-text">
                <thead>
                    <tr><th>Product Name</th><th>Stock Value</th></tr>
                </thead>
                <tbody>
                     {% for item in inventory_overview.highest_value|default_if_none:"[]" %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td>‚Ç±{{ item.metric_value|floatformat:2|intcomma }}</td> 
                    </tr>
                    {% empty %}
                     <tr><td colspan="2" class="no-data-cell"><p>No data.</p></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="report-section searchable-section">
    <h2>Reservation Statistics</h2>
     <div class="overview-grid single-col"> 
         <div class="table-container">
            <h3>Most Reserved Items (Top 5)</h3>
            <table class="data-table small-text">
                 <thead>
                    <tr><th>Product Name</th><th>Reservations</th></tr>
                </thead>
                 <tbody>
                    {% for item in reservation_stats.most_reserved|default_if_none:"[]" %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td>{{ item.metric_value|floatformat:0|intcomma }} times</td> 
                    </tr>
                    {% empty %}
                     <tr><td colspan="2" class="no-data-cell"><p>No reservation data available.</p></td></tr>
                    {% endfor %}
                </tbody>
            </table>
         </div>
    </div>
</div>

<div class="report-section searchable-section">
    <h2>Sales Performance</h2>
    <div class="overview-grid"> 
        <div class="table-container">
            <h3>Sales by Category</h3>
            <table class="data-table small-text">
                <thead>
                    <tr><th>Category</th><th>Total Revenue</th></tr>
                </thead>
                 <tbody>
                    {% for item in sales_performance.by_category|default_if_none:"[]" %}
                    <tr>
                        <td>{{ item.category }}</td>
                        <td>‚Ç±{{ item.total_revenue|floatformat:2|intcomma }}</td>
                    </tr>
                    {% empty %}
                     <tr><td colspan="2" class="no-data-cell"><p>No sales data available.</p></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-container">
            <h3>Top 5 Best-Selling Items (Quantity)</h3>
            <table class="data-table small-text">
                 <thead>
                    <tr><th>Product Name</th><th>Quantity Sold</th></tr>
                </thead>
                 <tbody>
                    {% for item in sales_performance.best_selling|default_if_none:"[]" %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td>{{ item.metric_value|floatformat:0|intcomma }} pcs</td> 
                    </tr>
                    {% empty %}
                     <tr><td colspan="2" class="no-data-cell"><p>No data.</p></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-container">
            <h3>Top 5 Highest Revenue Items</h3>
            <table class="data-table small-text">
                 <thead>
                    <tr><th>Product Name</th><th>Revenue</th></tr>
                </thead>
                 <tbody>
                    {% for item in sales_performance.highest_revenue|default_if_none:"[]" %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td>‚Ç±{{ item.metric_value|floatformat:2|intcomma }}</td> 
                    </tr>
                    {% empty %}
                     <tr><td colspan="2" class="no-data-cell"><p>No data.</p></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="report-section searchable-section">
<h2>Unavailable Products</h2>
    <div class="table-container">
        <table class="data-table">
            <thead><tr><th>Product Name</th><th>Category</th><th>Current Stock</th></tr></thead>
            <tbody>
                {% for product in unavailable_products %}
                <tr><td>{{ product.name }}</td><td>{{ product.category }}</td><td><span class="status-highlight-unavailable">{{ product.stock_quantity }} pcs</span></td></tr>
                {% empty %}
                <tr><td colspan="3" class="no-data-cell"><p>üëç All products are currently available.</p></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="report-section searchable-section">
    <h2>Low-Stock Items (Needs Reordering)</h2>
    <div class="table-container">
        <table class="data-table">
            <thead><tr><th>Product Name</th><th>Category</th><th>Remaining Stock</th></tr></thead>
            <tbody>
                {% for product in low_stock_products %}
                <tr><td>{{ product.name }}</td><td>{{ product.category }}</td><td><span class="stock-highlight">{{ product.stock_quantity }} pcs</span></td></tr>
                {% empty %}
                <tr><td colspan="3" class="no-data-cell"><p>üëç No items are currently low on stock.</p></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="log-section-content">
    <div class="report-section searchable-section activity-log-section"> 
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; border: none; padding: 0;">System Activity Log</h2>
            <button type="button" class="btn btn-danger" id="clear-all-logs-btn">
                Clear All Logs
            </button>
        </div>
        <div class="page-controls">
            <form class="search-form log-search-form" onsubmit="return false;"> 
                <input type="search" id="log-search-input" name="search" class="search-input" placeholder="Search logs by action or user..." value="">
            </form>
        </div>
        <form id="batch-log-delete-form" method="POST" action="{% url 'batch_delete_logs' %}">
            {% csrf_token %} <input type="hidden" name="log_ids" id="batch-log-ids-input">
        </form>
        <div class="table-container">
            <table class="data-table log-table">
                <thead><tr><th class="checkbox-col"><input type="checkbox" id="select-all-logs-checkbox"></th><th>Timestamp</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                <tbody id="log-table-body">
                    {% for entry in log_entries %}
                    <tr data-log-id="{{ entry.id }}" data-user="{{ entry.user_full_name|default:'System'|lower }}" data-action="{{ entry.action|lower }}"> 
                        <td><input type="checkbox" class="log-checkbox" value="{{ entry.id }}"></td>
                        <td>{{ entry.created_at|date:"M d, Y, P" }}</td>
                        <td>{{ entry.user_full_name|default:'System' }}</td>
                        <td><span class="badge">{{ entry.action_display }}</span></td>
                        
                        <td>
                            {% if entry.action == 'STUDENT_STATUS_UPDATED' %}
                                Student: <strong>{{ entry.details.student_name }}</strong> ({{ entry.details.student_id_num }})
                                - Action: <strong>{{ entry.details.action_taken|title }}</strong>
                            
                            {% elif entry.action == 'STUDENT_DELETED' %}
                                Student: <strong>{{ entry.details.student_name }}</strong> ({{ entry.details.student_id_num }})
                                - <strong style="color: #991b1b;">Deleted</strong>
                            
                            {% elif entry.action == 'ORDER_STATUS_UPDATED' %}
                                Order: <strong>#{{ entry.details.order_id }}</strong>
                                - Product: <strong>{{ entry.details.product_name }}</strong>
                                - Student: <strong>{{ entry.details.student_name }}</strong>
                                - Status: <strong>{{ entry.details.new_status|title }}</strong>

                            {% elif entry.action == 'ORDER_STATUS_BATCH_UPDATED' %}
                                {{ entry.details.count }} Order(s) updated
                                - Status: <strong>{{ entry.details.new_status|title }}</strong>
                                - (IDs: {{ entry.details.order_ids|join:", " }})

                            {% elif entry.action == 'ORDER_DELETED' %}
                                Order: <strong>#{{ entry.details.order_id }}</strong>
                                - Product: <strong>{{ entry.details.product_name }}</strong>
                                - Student: <strong>{{ entry.details.student_name }}</strong>
                                - <strong style="color: #991b1b;">Deleted</strong>

                            {% elif entry.action == 'ORDER_BATCH_DELETED' %}
                                Deleted <strong>{{ entry.details.count }}</strong> order(s)
                                - (IDs: {{ entry.details.order_ids|join:", " }})
                                - <strong style="color: #991b1b;">Deleted</strong>
                            
                            {% elif entry.action == 'PRODUCT_EDITED' %}
                                Product: <strong>{{ entry.details.product_name }}</strong> (ID: {{ entry.details.product_id }})
                                - Changes: <strong>{{ entry.details.changes }}</strong>
                            
                            {% elif entry.action == 'PRODUCT_BATCH_DELETE' %}
                                Deleted <strong>{{ entry.details.count }}</strong> product(s)
                                - (IDs: {{ entry.details.product_ids|join:", " }})
                                - <strong style="color: #991b1b;">Deleted</strong>

                            {% elif entry.details.product_name %}
                                Product: {{ entry.details.product_name }} (ID: {{ entry.details.product_id }})
                            
                            {% elif entry.details.order_id %}
                                Order ID: #{{ entry.details.order_id }}
                                {% if entry.details.new_status %} ‚Üí Status: {{ entry.details.new_status|title }}{% endif %}
                            
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        
                    </tr>
                    {% empty %}
                    <tr id="no-logs-row"><td colspan="5" class="no-data-cell"><p>No system activity has been recorded yet.</p></td></tr>
                    {% endfor %}
                    <tr id="no-log-results-row" style="display: none;"><td colspan="5" class="no-data-cell"><p>No log entries found matching your search.</p></td></tr>
                </tbody>
            </table>
        </div>
        <div class="pagination-container">
            {% if log_pagination.total_pages > 1 %}
                <nav aria-label="Log page navigation">
                    <ul class="pagination">
                        {# Previous Button #}
                        {% if log_pagination.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ log_pagination.param_name }}={{ log_pagination.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&laquo;</span>
                            </li>
                        {% endif %}

                        {# Page Numbers #}
                        {% for page_num in log_pagination.page_range %}
                            {% if page_num == log_pagination.current_page %}
                                <li class="page-item active" aria-current="page"><span class="page-link">{{ page_num }}</span></li>
                            {% else %}
                                <li class="page-item"><a class="page-link" href="?{{ log_pagination.param_name }}={{ page_num }}">{{ page_num }}</a></li>
                            {% endif %}
                        {% endfor %}

                        {# Next Button #}
                        {% if log_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{{ log_pagination.param_name }}={{ log_pagination.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link" aria-hidden="true">&raquo;</span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                <div class="pagination-info">
                    Page {{ log_pagination.current_page }} of {{ log_pagination.total_pages }} ({{ total_log_count }} total logs)
                </div>
            {% elif total_log_count > 0 %}
                 <div class="pagination-info">
                     {{ total_log_count }} log entr{{ total_log_count|pluralize:"y,ies" }} found.
                 </div>
            {% endif %}
        </div>
    </div> 
</div>
<div id="global-no-results" class="no-data-message" style="display: none; margin-top: 2rem;">
    <p>No report sections found matching your search.</p>
</div>
<div id="log-delete-bar" class="batch-action-bar" style="display: none;"> <span id="log-selected-count">0 items selected</span> <button type="button" class="btn btn-danger" id="batch-log-delete-btn">Delete Selected</button> </div>
<div id="log-delete-confirm-modal" class="modal" style="display: none;"> <div class="modal-content" style="max-width: 450px;"> <div class="modal-header"><h2>Confirm Log Deletion</h2><span class="close-btn">&times;</span></div> <div class="modal-body"> <p>Are you sure you want to permanently delete <strong id="log-delete-count">0</strong> log(s)?</p> <p>This action cannot be undone.</p> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button> <button type="button" class="btn btn-danger" id="confirm-log-delete-btn">Yes, Delete Selected</button> </div> </div> </div>

<div id="clear-all-logs-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header"><h2>Confirm Clear All Logs</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <p>Are you sure you want to permanently delete <strong>ALL</strong> log entries?</p>
            <p>This action cannot be undone and will reset the log.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-clear-all-logs-btn">Yes, Clear All</button>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ status_counts|json_script:"chart-data" }}

<script>
// ==================================================================
// == 1. HELPER FUNCTIONS
// ==================================================================
function showMessage(message, type = 'success') {
    const container = document.getElementById('message-container');
    if (!container) return;
    const li = document.createElement('li');
    li.className = type;
    li.textContent = ` ${message}`;
    const iconSpan = document.createElement('span');
    iconSpan.textContent = (type === 'success') ? '‚úÖ' : '‚ùå';
    li.prepend(iconSpan);
    container.appendChild(li);
    setTimeout(() => {
        li.style.opacity = '0';
        setTimeout(() => { li.remove(); }, 500);
    }, 4000);
}

function getCsrfToken() {
    // Check both forms now, starting with the batch delete form
    let form = document.getElementById('batch-log-delete-form');
    let tokenInput = form ? form.querySelector('[name=csrfmiddlewaretoken]') : null;
    
    // Fallback to the clear-all form (though it doesn't exist, this is good practice if it did)
    // Or just rely on the one form that *does* have a token.
    
    return tokenInput ? tokenInput.value : '';
}

function openModal(modal) {
    if (modal) modal.style.display = 'flex';
}

function closeModal(modal) {
    if (modal) modal.style.display = 'none';
}

document.addEventListener('DOMContentLoaded', () => {

    // ==================================================================
    // == 2. CHART LOGIC (Unchanged)
    // ==================================================================
    const dataElement = document.getElementById('chart-data');
    const chartCanvas = document.getElementById('orderStatusChart');
    if (dataElement && chartCanvas) {
        try {
            const statusData = JSON.parse(dataElement.textContent);
            const hasData = Object.values(statusData).some(count => count > 0);
            if (hasData) { 
                const ctx = chartCanvas.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Pending', 'Approved', 'Completed', 'Rejected', 'Cancelled'],
                            datasets: [{
                                label: 'Order Statuses',
                                data: [
                                    statusData.pending || 0,
                                    statusData.approved || 0,
                                    statusData.completed || 0,
                                    statusData.rejected || 0,
                                    statusData.cancelled || 0
                                ],
                                backgroundColor: ['#f59e0b', '#22c55e', '#3b82f6', '#ef4444', '#6b7280'],
                                borderColor: '#ffffff',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true, 
                            layout: { padding: { left: 5, right: 5, top: 5, bottom: 5 } },
                            plugins: {
                                legend: {
                                    position: 'right', 
                                    labels: { boxWidth: 15, padding: 10, font: { size: 12 } }
                                }
                            }
                        }
                    });
                }
            } else {
                 const container = chartCanvas.parentElement;
                 if (container) {
                     container.innerHTML = '<p style="text-align: center; color: #64748b; margin-top: 50px;">No order data available to display chart.</p>';
                 }
            }
        } catch (e) {
            console.error("ERROR during chart initialization:", e);
        }
    }

    // ==================================================================
    // == 3. LOG DELETION LOGIC
    // ==================================================================
    const logDeleteForm = document.getElementById('batch-log-delete-form');
    const logDeleteBar = document.getElementById('log-delete-bar');
    const logSelectedCount = document.getElementById('log-selected-count');
    const selectAllLogsCheckbox = document.getElementById('select-all-logs-checkbox');
    const batchLogDeleteBtn = document.getElementById('batch-log-delete-btn');
    const logDeleteModal = document.getElementById('log-delete-confirm-modal');
    const confirmLogDeleteBtn = document.getElementById('confirm-log-delete-btn');
    const logTableBody = document.getElementById('log-table-body');
    let noLogsRow = document.getElementById('no-logs-row'); // Use let
    const noLogResultsRow = document.getElementById('no-log-results-row');
    
    // NEW: "Clear All" Elements
    const clearAllLogsBtn = document.getElementById('clear-all-logs-btn');
    const clearAllLogsModal = document.getElementById('clear-all-logs-confirm-modal');
    const confirmClearAllLogsBtn = document.getElementById('confirm-clear-all-logs-btn');

    function updateLogDeleteBar() {
        if (!logDeleteBar || !logSelectedCount) return;
        const selectedVisible = document.querySelectorAll('#log-table-body tr:not([style*="display: none"]) .log-checkbox:checked');
        const totalVisibleCheckboxes = document.querySelectorAll('#log-table-body tr:not([style*="display: none"]) .log-checkbox');
        const count = selectedVisible.length;

        if (count > 0) {
            logDeleteBar.style.display = 'flex';
            logSelectedCount.textContent = `${count} item${count > 1 ? 's' : ''} selected`;
        } else {
            logDeleteBar.style.display = 'none';
        }

        if (selectAllLogsCheckbox) {
            const allVisibleCount = totalVisibleCheckboxes.length;
             selectAllLogsCheckbox.checked = (count > 0 && count === allVisibleCount && allVisibleCount > 0);
             selectAllLogsCheckbox.indeterminate = (count > 0 && count < allVisibleCount);
        }

        document.querySelectorAll('#log-table-body tr').forEach(row => {
            const cb = row.querySelector('.log-checkbox');
            const isVisible = row.style.display !== 'none';
            if (cb) {
                 row.classList.toggle('row-selected', cb.checked && isVisible);
            }
        });
    }

    if (selectAllLogsCheckbox) {
        selectAllLogsCheckbox.addEventListener('change', () => {
            const isChecked = selectAllLogsCheckbox.checked;
            document.querySelectorAll('#log-table-body tr:not([style*="display: none"]) .log-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });
            updateLogDeleteBar();
        });
    } 

    const logCheckboxesInitial = document.querySelectorAll('.log-checkbox');
    logCheckboxesInitial.forEach(cb => {
        cb.addEventListener('change', (event) => {
            updateLogDeleteBar();
        });
    });

    if (batchLogDeleteBtn) {
        batchLogDeleteBtn.addEventListener('click', () => {
            const selectedVisible = document.querySelectorAll('#log-table-body tr:not([style*="display: none"]) .log-checkbox:checked');
            const count = selectedVisible.length;
            if (count > 0 && logDeleteModal) {
                const countSpan = logDeleteModal.querySelector('#log-delete-count');
                if (countSpan) { countSpan.textContent = count; }
                openModal(logDeleteModal);
            }
        });
    } 

    document.querySelectorAll('.cancel-modal-btn, .close-btn').forEach(btn => {
        btn.addEventListener('click', () => closeModal(btn.closest('.modal')));
    });
     window.addEventListener('click', (e) => {
         if (e.target.classList.contains('modal')) closeModal(e.target);
     });

    if (confirmLogDeleteBtn && logDeleteForm) {
        confirmLogDeleteBtn.addEventListener('click', () => {
            const selectedVisibleCheckboxes = document.querySelectorAll('#log-table-body tr:not([style*="display: none"]) .log-checkbox:checked');
            const ids = Array.from(selectedVisibleCheckboxes).map(cb => cb.value);
            if (ids.length === 0) { closeModal(logDeleteModal); return; }

            const formData = new FormData(logDeleteForm);
            formData.set('log_ids', ids.join(','));

            const button = confirmLogDeleteBtn;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Deleting...';

            fetch(logDeleteForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => {
                 if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                 return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeModal(logDeleteModal);
                    data.deleted_ids.forEach(id => {
                        document.querySelector(`tr[data-log-id="${id}"]`)?.remove();
                    });
                    filterLogs(); // Re-run filter which calls updateLogDeleteBar
                } else {
                    showMessage(data.error || 'An unknown error occurred.', 'error');
                }
            })
            .catch(error => {
                showMessage(`A network error occurred: ${error.message}`, 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        });
    }

    // --- NEW: "CLEAR ALL LOGS" LOGIC ---
    if (clearAllLogsBtn && confirmClearAllLogsBtn && clearAllLogsModal) {
        // 1. Open the confirm modal
        clearAllLogsBtn.addEventListener('click', () => {
            openModal(clearAllLogsModal);
        });

        // 2. Handle the final confirmation
        confirmClearAllLogsBtn.addEventListener('click', () => {
            const button = confirmClearAllLogsBtn;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Clearing...';

            fetch("{% url 'clear_all_logs' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(), // Use the same CSRF token
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    closeModal(clearAllLogsModal);
                    
                    // Clear the UI
                    logTableBody.innerHTML = ''; // Remove all rows
                    
                    // Re-create or find the 'noLogsRow'
                    if (!noLogsRow) {
                        // If it was removed, create it
                        noLogsRow = document.createElement('tr');
                        noLogsRow.id = 'no-logs-row';
                        noLogsRow.innerHTML = '<td colspan="5" class="no-data-cell"><p></p></td>';
                        logTableBody.appendChild(noLogsRow);
                    }
                    
                    noLogsRow.querySelector('p').textContent = "Log cleared. New log for this action will appear on next refresh.";
                    noLogsRow.style.display = ''; 
                    
                    if (noLogResultsRow) noLogResultsRow.style.display = 'none'; // Hide no results row
                    if (selectAllLogsCheckbox) selectAllLogsCheckbox.checked = false;
                    updateLogDeleteBar(); // This will hide the bar
                } else {
                    showMessage(data.error || 'An unknown error occurred.', 'error');
                }
            })
            .catch(error => {
                showMessage(`A network error occurred: ${error.message}`, 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        });
    }
    //END: "CLEAR ALL LOGS" LOGIC


    // ==================================================================
    // == 4. LIVE SEARCH FILTER FOR LOGS
    // ==================================================================
    const logSearchInput = document.getElementById('log-search-input');

    function filterLogs() {
        if (!logSearchInput || !logTableBody) return;

        const searchTerm = logSearchInput.value.toLowerCase().trim();
        const logRows = logTableBody.querySelectorAll('tr[data-log-id]');
        let visibleRowCount = 0;

        logRows.forEach(row => {
            const user = row.dataset.user || '';
            const action = row.dataset.action || '';
            const rowMatches = (user.includes(searchTerm) || action.includes(searchTerm));

            row.style.display = rowMatches ? '' : 'none';
            if (rowMatches) {
                 visibleRowCount++;
            } else {
                 const cb = row.querySelector('.log-checkbox');
                 if (cb) cb.checked = false;
            }
        });
        
        const hasLogsNow = logTableBody.querySelectorAll('tr[data-log-id]').length > 0;

        if (noLogResultsRow) {
            noLogResultsRow.style.display = (visibleRowCount === 0 && hasLogsNow && searchTerm) ? '' : 'none';
        }
        if (noLogsRow) {
            // Show 'no logs' row only if there are no logs at all AND no search term
            noLogsRow.style.display = (!hasLogsNow && !searchTerm) ? '' : 'none';
        }

         updateLogDeleteBar();
    }

    if (logSearchInput) {
        logSearchInput.addEventListener('input', filterLogs);
        filterLogs(); 
    } 

    // ==================================================================
    // == 5. GLOBAL REPORT SEARCH (NEW)
    // ==================================================================
    const globalSearchInput = document.getElementById('global-report-search');
    const allSearchableSections = document.querySelectorAll('.searchable-section'); 
    const globalNoResults = document.getElementById('global-no-results');

    function filterGlobalReports() {
        if (!globalSearchInput || !allSearchableSections.length || !globalNoResults) {
            console.warn("Global search elements missing. Search will not work.");
            return;
        }
        const searchTerm = globalSearchInput.value.toLowerCase().trim();
        let visibleSections = 0;
        
        allSearchableSections.forEach(section => {
            const sectionText = section.textContent.toLowerCase();
            const isMatch = sectionText.includes(searchTerm);
            section.style.display = isMatch ? '' : 'none';
            
            if (isMatch) {
                visibleSections++;
                if (section.classList.contains('activity-log-section') && typeof filterLogs === 'function') {
                    filterLogs();
                }
            }
        });
        globalNoResults.style.display = (visibleSections === 0 && searchTerm) ? 'block' : 'none';
    }

    if (globalSearchInput) {
        globalSearchInput.addEventListener('input', filterGlobalReports);
        filterGlobalReports(); 
    }

    // ==================================================================
    // == 6. AJAX PAGINATION FOR LOGS (NEW)
    // ==================================================================
    const logSectionContent = document.getElementById('log-section-content');

    function handleAjaxPagination(event) {
        const targetLink = event.target.closest('a.page-link');
        if (!targetLink || !logSectionContent) {
            return;
        }
        event.preventDefault();

        const url = targetLink.href;
        if (!url) return;

        logSectionContent.style.opacity = '0.5'; 

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest' 
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text(); 
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newLogContent = doc.getElementById('log-section-content');

            if (newLogContent) {
                logSectionContent.innerHTML = newLogContent.innerHTML;
                history.pushState({}, '', url);

                // --- Re-attach Listeners for the new content ---
                const newLogSearchInput = logSectionContent.querySelector('#log-search-input');
                const newSelectAllCheckbox = logSectionContent.querySelector('#select-all-logs-checkbox');
                const newLogCheckboxes = logSectionContent.querySelectorAll('.log-checkbox');
                const newPaginationContainer = logSectionContent.querySelector('.pagination-container'); 

                if (newLogSearchInput) {
                    newLogSearchInput.addEventListener('input', filterLogs);
                }
                if (newSelectAllCheckbox) {
                    newSelectAllCheckbox.addEventListener('change', handleSelectAllChange); 
                }
                newLogCheckboxes.forEach(cb => {
                    cb.addEventListener('change', updateLogDeleteBar); 
                });
                 if (newPaginationContainer) {
                      newPaginationContainer.addEventListener('click', handleAjaxPagination);
                 }
                filterLogs(); 
                updateLogDeleteBar(); 
            } else {
                console.error("AJAX Pagination: Could not find '#log-section-content' in fetched HTML.");
                throw new Error("Invalid response content.");
            }
        })
        .catch(error => {
            console.error('AJAX Pagination Error:', error);
            showMessage(`Failed to load page: ${error.message}`, 'error');
        })
        .finally(() => {
            logSectionContent.style.opacity = '1'; 
        });
    }

    const initialPaginationContainer = logSectionContent?.querySelector('.pagination-container');
    if (initialPaginationContainer) {
        initialPaginationContainer.addEventListener('click', handleAjaxPagination);
        console.log("Attached initial AJAX pagination listener.");
    } else if (logSectionContent){ 
         console.log("Log pagination container not found initially (likely only one page).");
    } else {
         console.warn("Log section content container ('#log-section-content') not found.");
    }

    function handleSelectAllChange() {
       const selectAllCheckbox = logSectionContent.querySelector('#select-all-logs-checkbox'); 
       if (!selectAllCheckbox) return;
        const isChecked = selectAllCheckbox.checked;
        logSectionContent.querySelectorAll('#log-table-body tr:not([style*="display: none"]) .log-checkbox').forEach(cb => {
            cb.checked = isChecked;
        });
        updateLogDeleteBar();
    }
     const initialSelectAll = logSectionContent?.querySelector('#select-all-logs-checkbox');
     if (initialSelectAll) {
         initialSelectAll.addEventListener('change', handleSelectAllChange);
     }

}); // End DOMContentLoaded
</script>
{% endblock %}