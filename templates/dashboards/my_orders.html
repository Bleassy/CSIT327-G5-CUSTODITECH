{% extends 'dashboards/student_base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/my_orders.css' %}?v=1.5">
{% endblock %}

{% block content %}
<h1 class="welcome-title">My Orders ðŸ“¦</h1>



<div class="search-container">
    <input type="search" id="order-search-input" class="search-input"
           placeholder="Search by name, category, or status (approved, pending, completed, cancelled, rejected)..."
           value="{{ search_query }}">
</div>

<form id="batch-order-form" method="POST" action="{% url 'batch_delete_orders' %}">
    {% csrf_token %}
    <input type="hidden" name="order_ids" id="batch-order-ids">

    <section class="order-section" data-section-status="approved">
        <h2 class="section-title">Approved (Ready for Pickup)</h2>
        <div class="orders-grid">
            {% for item in approved_orders %}
            <div class="order-card"
                 data-id="{{ item.id }}"
                 data-name="{{ item.product_name }}"
                 data-size="{{ item.product_size|default:'' }}"
                 data-category="{{ item.product_category|default:'N/A' }}"
                 data-description="{{ item.product_description|default:'No description available.' }}"
                 data-image-url="{{ item.product_image_url|default:'https://placehold.co/400x300/e0e7ff/3730a3?text=Item' }}"
                 data-quantity="{{ item.quantity }}"
                 data-total-price="{{ item.total_price|floatformat:2 }}"
                 data-payment-method="{{ item.payment_method|default:'Cash'|title }}"
                 data-created-at="{{ item.created_at|date:'M d, Y' }}"
                 data-status="{{ item.status }}">

                <img src="{{ item.product_image_url|default:'...' }}" alt="{{ item.product_name }}" class="product-image">
                <div class="card-body">
                     <div class="card-header">
                          <h3 class="product-name">{{ item.product_name }}{% if item.product_size %} - {{ item.product_size }}{% endif %}</h3>
                         <span class="status-badge status-{{ item.status }}">{{ item.status|title }}</span>
                     </div>
                     <div class="details-grid">
                         <span>Date Ordered:</span><strong>{{ item.created_at|date:"M d, Y" }}</strong>
                         <span>Quantity:</span><strong>{{ item.quantity }} pc(s)</strong>
                         <span>Total Price:</span><strong>â‚±{{ item.total_price|floatformat:2 }}</strong>
                     </div>
                      <div class="info-note">
                          <p>Claim your product at the Custodian Department within 3 days after it has been approved. Unclaimed items will be forfeited.</p>
                      </div>
                </div>
            </div>
            {% empty %} <p class="no-items-message">You have no orders ready for pickup.</p> {% endfor %}
        </div>
    </section>

    <section class="order-section" data-section-status="pending">
        <h2 class="section-title">Pending Orders</h2>
        <div class="orders-grid">
            {% for item in pending_orders %}
             <div class="order-card" data-id="{{ item.id }}" data-name="{{ item.product_name }}" data-size="{{ item.product_size|default:'' }}" data-category="{{ item.product_category|default:'N/A' }}" data-description="{{ item.product_description|default:'No description available.' }}" data-image-url="{{ item.product_image_url|default:'...' }}" data-quantity="{{ item.quantity }}" data-total-price="{{ item.total_price|floatformat:2 }}" data-payment-method="{{ item.payment_method|default:'Cash'|title }}" data-created-at="{{ item.created_at|date:'M d, Y' }}" data-status="{{ item.status }}">
                <img src="{{ item.product_image_url|default:'...' }}" alt="{{ item.product_name }}" class="product-image">
                 <div class="card-body">
                     <div class="card-header">
                          <h3 class="product-name">{{ item.product_name }}{% if item.product_size %} - {{ item.product_size }}{% endif %}</h3>
                         <span class="status-badge status-{{ item.status }}">{{ item.status|title }}</span>
                     </div>
                     <div class="details-grid">
                          <span>Date Ordered:</span><strong>{{ item.created_at|date:"M d, Y" }}</strong>
                          <span>Quantity:</span><strong>{{ item.quantity }} pc(s)</strong>
                          <span>Total Price:</span><strong>â‚±{{ item.total_price|floatformat:2 }}</strong>
                     </div>
                 </div>
            </div>
            {% empty %} <p class="no-items-message">You have no pending orders.</p> {% endfor %}
        </div>
    </section>

    <section class="order-section" data-section-status="completed">
        <h2 class="section-title">Completed Orders</h2>
        {% if completed_orders %}
        <div class="select-all-container">
            <input type="checkbox" id="select-all-completed" class="select-all-checkbox" data-section="completed">
            <label for="select-all-completed">Select All Completed</label>
        </div>
        {% endif %}
        <div class="orders-grid completed-grid">
            {% for item in completed_orders %}
             <div class="order-card history" data-id="{{ item.id }}" data-name="{{ item.product_name }}" data-size="{{ item.product_size|default:'' }}" data-category="{{ item.product_category|default:'N/A' }}" data-description="{{ item.product_description|default:'...' }}" data-image-url="{{ item.product_image_url|default:'...' }}" data-quantity="{{ item.quantity }}" data-total-price="{{ item.total_price|floatformat:2 }}" data-payment-method="{{ item.payment_method|default:'Cash'|title }}" data-created-at="{{ item.created_at|date:'M d, Y' }}" data-status="{{ item.status }}">
                 <input type="checkbox" class="order-checkbox completed-checkbox" value="{{ item.id }}">
                <img src="{{ item.product_image_url|default:'...' }}" alt="{{ item.product_name }}" class="product-image">
                 <div class="card-body">
                     <div class="card-header">
                          <h3 class="product-name">{{ item.product_name }}{% if item.product_size %} - {{ item.product_size }}{% endif %}</h3>
                         <span class="status-badge status-{{ item.status }}">{{ item.status|title }}</span>
                     </div>
                     <div class="details-grid">
                          <span>Date Ordered:</span><strong>{{ item.created_at|date:"M d, Y" }}</strong>
                          <span>Quantity:</span><strong>{{ item.quantity }} pc(s)</strong>
                          <span>Total Price:</span><strong>â‚±{{ item.total_price|floatformat:2 }}</strong>
                     </div>
                 </div>
            </div>
            {% empty %} <p class="no-items-message">You have no completed orders.</p> {% endfor %}
        </div>
    </section>

    <section class="order-section" data-section-status="cancelled rejected">
        <h2 class="section-title">Cancelled or Rejected Orders</h2>
        {% if other_orders %}
        <div class="select-all-container">
            <input type="checkbox" id="select-all-other" class="select-all-checkbox" data-section="other">
            <label for="select-all-other">Select All Cancelled/Rejected</label>
        </div>
        {% endif %}
        <div class="orders-grid other-grid">
            {% for item in other_orders %}
            <div class="order-card history" data-id="{{ item.id }}" data-name="{{ item.product_name }}" data-size="{{ item.product_size|default:'' }}" data-category="{{ item.product_category|default:'N/A' }}" data-description="{{ item.product_description|default:'...' }}" data-image-url="{{ item.product_image_url|default:'...' }}" data-quantity="{{ item.quantity }}" data-total-price="{{ item.total_price|floatformat:2 }}" data-payment-method="{{ item.payment_method|default:'Cash'|title }}" data-created-at="{{ item.created_at|date:'M d, Y' }}" data-status="{{ item.status }}">
                 <input type="checkbox" class="order-checkbox other-checkbox" value="{{ item.id }}">
                <img src="{{ item.product_image_url|default:'...' }}" alt="{{ item.product_name }}" class="product-image">
                 <div class="card-body">
                     <div class="card-header">
                          <h3 class="product-name">{{ item.product_name }}{% if item.product_size %} - {{ item.product_size }}{% endif %}</h3>
                         <span class="status-badge status-{{ item.status }}">{{ item.status|title }}</span>
                     </div>
                     <div class="details-grid">
                          <span>Date Ordered:</span><strong>{{ item.created_at|date:"M d, Y" }}</strong>
                          <span>Quantity:</span><strong>{{ item.quantity }} pc(s)</strong>
                          <span>Total Price:</span><strong>â‚±{{ item.total_price|floatformat:2 }}</strong>
                     </div>
                 </div>
            </div>
            {% empty %} <p class="no-items-message">You have no cancelled or rejected orders.</p> {% endfor %}
        </div>
    </section>
</form>

<div id="batch-action-bar" class="batch-action-bar" style="display: none;">
    <span id="selected-count">0 items selected</span>
    <button type="button" class="btn btn-danger" id="batch-delete-btn">Delete Selected</button>
</div>


<div id="order-details-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Order Details</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <div class="details-layout">
                <div class="details-image-container"> <img id="details-image" src="" alt="Product Image" class="details-image"> </div>
                <div class="details-info">
                    <h3 id="details-name" class="details-name"></h3>
                    <p><strong>Category:</strong> <span id="details-category"></span></p>
                    <p id="details-description" class="details-description"></p>
                    <div class="details-summary-grid">
                        <span>Date Ordered:</span><strong id="details-created-at"></strong>
                        <span>Quantity:</span><strong id="details-quantity"></strong>
                        <span>Total Price:</span><strong id="details-total-price"></strong>
                        <span>Payment Method:</span><strong id="details-payment-method"></strong>
                        <span>Status:</span><strong id="details-status-text"></strong>
                    </div>
                     <div class="info-note" id="details-claim-note" style="display: none;"> <p>Claim your product at the Custodian Department within 3 days after it has been approved. Unclaimed items will be forfeited.</p> </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-modal-btn">Close</button>
            <button type="button" class="btn btn-danger" id="details-delete-btn" style="display: none;" data-order-id="">Delete Order</button>
        </div>
    </div>
</div>

<div id="batch-delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Batch Deletion</h2><span class="close-btn">&times;</span></div>
        <div class="modal-body">
            <p>Are you sure you want to permanently delete <strong id="batch-delete-count">0</strong> order(s)?</p>
            <p>This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-batch-delete-btn">Yes, Delete Selected</button>
        </div>
    </div>
</div>

<div id="delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2>Confirm Deletion</h2><span class="close-btn">&times;</span></div>
        <form id="delete-single-order-form" method="post">
            {% csrf_token %}
            <div class="modal-body">
                <p>Are you sure you want to permanently delete the order for:</p>
                <div class="summary">
                    <p><strong>Product:</strong> <span id="delete-confirm-product-name"></span></p>
                </div>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary cancel-modal-btn">Cancel</button>
                <button type="submit" class="btn btn-danger">Yes, Delete Order</button>
            </div>
        </form>
    </div>
</div>



{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Get Modals & Elements ---
    const detailsModal = document.getElementById('order-details-modal');
    const deleteConfirmModal = document.getElementById('delete-confirm-modal');
    const batchDeleteConfirmModal = document.getElementById('batch-delete-confirm-modal');
    const batchActionBar = document.getElementById('batch-action-bar');
    const selectedCountSpan = document.getElementById('selected-count');
    const batchDeleteBtn = document.getElementById('batch-delete-btn');
    const batchForm = document.getElementById('batch-order-form');
    const batchOrderIdsInput = document.getElementById('batch-order-ids');
    const allOrderCards = document.querySelectorAll('.order-card');

    // Checkboxes
    const allOrderCheckboxes = document.querySelectorAll('.order-checkbox');
    const selectAllCompletedCheckbox = document.getElementById('select-all-completed');
    const completedCheckboxes = document.querySelectorAll('.completed-checkbox');
    const selectAllOtherCheckbox = document.getElementById('select-all-other');
    const otherCheckboxes = document.querySelectorAll('.other-checkbox');

    // --- General Modal Controls ---
    const openModal = (modal) => modal.style.display = 'flex';
    const closeModal = (modal) => modal.style.display = 'none';
    document.querySelectorAll('.close-btn, .cancel-modal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeModal(btn.closest('.modal'));
        });
    });
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal') && e.target) { 
             closeModal(e.target);
        }
    });

    // --- Search Functionality ---
    const searchInput = document.getElementById('order-search-input');
    const orderSections = document.querySelectorAll('.order-section');
    function filterOrders() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let anyCardVisibleOverall = false;
        orderSections.forEach(section => {
            let sectionHasVisibleCards = false;
            const sectionStatus = section.dataset.sectionStatus.toLowerCase();
            section.querySelectorAll('.order-card').forEach(card => {
                const productName = card.dataset.name.toLowerCase();
                const category = card.dataset.category.toLowerCase();
                const status = card.dataset.status.toLowerCase();
                const cardMatches = productName.includes(searchTerm) || category.includes(searchTerm) || status.includes(searchTerm) || sectionStatus.split(' ').some(s => s.includes(searchTerm));
                card.style.display = cardMatches ? 'flex' : 'none';
                if (cardMatches) { sectionHasVisibleCards = true; anyCardVisibleOverall = true; }
            });
            section.style.display = sectionHasVisibleCards ? 'block' : 'none';
        });
    }
    searchInput.addEventListener('input', filterOrders);
    if (searchInput.value) filterOrders();

    // --- Order Details Modal Logic ---
    allOrderCards.forEach(card => {
        const checkbox = card.querySelector('.order-checkbox');
        
        // This makes the checkbox work when you click it directly
        if (checkbox) {
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation(); // Stop the card click from firing
                handleExclusiveSelection(checkbox); // Run exclusive logic
                updateBatchActionBar(); // Update the bar
            });
        }

        // This makes the whole card clickable
        card.addEventListener('click', (e) => {
            // Don't run if we're clicking the checkbox
            if (e.target.classList.contains('order-checkbox')) return;
            
            // Toggle the checkbox if it exists
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                handleExclusiveSelection(checkbox); // Run exclusive logic
                updateBatchActionBar(); // Update the bar
            }
            
            // Now, open the modal
            if (!detailsModal) { console.error("Details modal not found!"); return; }
            const data = card.dataset;
            detailsModal.querySelector('#details-image').src = data.imageUrl;
            const nameEl = detailsModal.querySelector('#details-name');
            nameEl.textContent = data.size ? `${data.name} - ${data.size}` : data.name;
            detailsModal.querySelector('#details-category').textContent = data.category;
            detailsModal.querySelector('#details-description').textContent = data.description;
            detailsModal.querySelector('#details-created-at').textContent = data.createdAt;
            detailsModal.querySelector('#details-quantity').textContent = `${data.quantity} pc(s)`;
            detailsModal.querySelector('#details-total-price').textContent = `â‚±${data.totalPrice}`;
            detailsModal.querySelector('#details-payment-method').textContent = data.paymentMethod;

            const statusTextEl = detailsModal.querySelector('#details-status-text');
            statusTextEl.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            statusTextEl.innerHTML = `<span class="status-badge status-${data.status}">${statusTextEl.textContent}</span>`;

            const claimNote = detailsModal.querySelector('#details-claim-note');
            claimNote.style.display = (data.status === 'approved') ? 'block' : 'none';

            const deleteBtn = detailsModal.querySelector('#details-delete-btn');
            if (deleteBtn) {
                if (['completed', 'cancelled', 'rejected'].includes(data.status)) {
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.dataset.orderId = data.id;
                    deleteBtn.dataset.name = data.name;
                    deleteBtn.dataset.size = data.size;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
            openModal(detailsModal);
        });
    });

    // --- Batch Action Logic ---
    function updateBatchActionBar() {
        const completedChecked = document.querySelectorAll('.completed-checkbox:checked').length;
        const otherChecked = document.querySelectorAll('.other-checkbox:checked').length;
        const count = completedChecked + otherChecked;

        if (batchActionBar) {
            if (count > 0) {
                batchActionBar.style.display = 'flex';
                selectedCountSpan.textContent = `${count} item${count > 1 ? 's' : ''} selected`;
            } else {
                batchActionBar.style.display = 'none';
            }
        }
        allOrderCheckboxes.forEach(cb => {
            cb.closest('.order-card').classList.toggle('selected', cb.checked);
        });
    }

    if (selectAllCompletedCheckbox) {
        selectAllCompletedCheckbox.addEventListener('change', () => {
            completedCheckboxes.forEach(cb => cb.checked = selectAllCompletedCheckbox.checked);
            handleExclusiveSelection(selectAllCompletedCheckbox, 'completed-checkbox');
            updateBatchActionBar();
        });
    }
    if (selectAllOtherCheckbox) {
        selectAllOtherCheckbox.addEventListener('change', () => {
            otherCheckboxes.forEach(cb => cb.checked = selectAllOtherCheckbox.checked);
            handleExclusiveSelection(selectAllOtherCheckbox, 'other-checkbox');
            updateBatchActionBar();
        });
    }
    
    // This listener is for when you click an individual checkbox
    allOrderCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            if (!checkbox.checked) {
                if (checkbox.classList.contains('completed-checkbox') && selectAllCompletedCheckbox) selectAllCompletedCheckbox.checked = false;
                if (checkbox.classList.contains('other-checkbox') && selectAllOtherCheckbox) selectAllOtherCheckbox.checked = false;
            }
            // handleExclusiveSelection(checkbox) is called by the 'click' listener
            updateBatchActionBar();
        });
    });
    
    // Helper function to manage exclusive selection
    function handleExclusiveSelection(clickedCheckbox, groupClass = null) {
        if (!clickedCheckbox.checked) return; // Only run on checking a box

        const clickedGroupClass = groupClass || (clickedCheckbox.classList.contains('completed-checkbox') ? 'completed-checkbox' : 'other-checkbox');

        // Uncheck all checkboxes from the OTHER group
        allOrderCheckboxes.forEach(cb => {
            if (clickedGroupClass === 'completed-checkbox' && cb.classList.contains('other-checkbox')) {
                cb.checked = false;
            } else if (clickedGroupClass === 'other-checkbox' && cb.classList.contains('completed-checkbox')) {
                cb.checked = false;
            }
        });

        // Uncheck the OTHER "Select All" toggle
        if (clickedGroupClass === 'completed-checkbox' && selectAllOtherCheckbox) {
            selectAllOtherCheckbox.checked = false;
        } else if (clickedGroupClass === 'other-checkbox' && selectAllCompletedCheckbox) {
            selectAllCompletedCheckbox.checked = false;
        }
    }

    // --- AJAX Logic ---
    const csrfToken = batchForm.querySelector('[name=csrfmiddlewaretoken]').value;

    function showDynamicMessage(message, className = 'success') {
        const messagesContainer = document.getElementById('messages-container');
        if (!messagesContainer) return;
        const li = document.createElement('li');
        li.className = className;
        li.textContent = message;
        messagesContainer.prepend(li);
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => {
            li.style.opacity = '0';
            li.style.transition = 'opacity 0.5s ease';
            setTimeout(() => li.remove(), 500);
        }, 5000);
    }
    
    function removeCardsFromUI(orderIds) {
        orderIds.forEach(id => {
            const card = document.querySelector(`.order-card[data-id="${id}"]`);
            if (card) {
                card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.95)';
                setTimeout(() => card.remove(), 500);
            }
        });
        updateBatchActionBar();
    }

    // --- AJAX for BATCH Delete ---
    const batchDeleteConfirmBtn = document.getElementById('confirm-batch-delete-btn');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.order-checkbox:checked')).map(cb => cb.value);
            const count = selectedIds.length;
            if (count === 0) { alert('Please select at least one order to delete.'); return; }
            if (batchDeleteConfirmModal) {
                 batchDeleteConfirmModal.querySelector('#batch-delete-count').textContent = count;
                 if(batchDeleteConfirmBtn) batchDeleteConfirmBtn.dataset.ids = selectedIds.join(',');
                 openModal(batchDeleteConfirmModal);
            }
        });
    }
    if (batchDeleteConfirmBtn) {
        batchDeleteConfirmBtn.addEventListener('click', async function() {
            const idsToSubmit = this.dataset.ids;
            if (!idsToSubmit) return;
            this.disabled = true;
            this.textContent = 'Deleting...';
            const formData = new FormData();
            formData.append('order_ids', idsToSubmit);
            try {
                const response = await fetch("{% url 'batch_delete_orders' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                closeModal(batchDeleteConfirmModal);
                showDynamicMessage(data.message, 'success');
                removeCardsFromUI(idsToSubmit.split(','));
            } catch (error) {
                closeModal(batchDeleteConfirmModal); // âœ… ADD THIS LINE
                showDynamicMessage(`Error: ${error.message}`, 'error');
            } finally {
                this.disabled = false;
                this.textContent = 'Yes, Delete Selected';
            }
        });
    }

    // --- AJAX for SINGLE Delete ---
    // This is the "Delete Order" button *inside* the details modal
    const detailsDeleteBtn = document.getElementById('details-delete-btn');
    if (detailsDeleteBtn) {
        detailsDeleteBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (deleteConfirmModal) {
                 closeModal(detailsModal);
                 openDeleteConfirmModal(this.dataset);
            }
        });
    }

    // This is the form *inside* the single delete confirmation modal
    const singleDeleteForm = document.getElementById('delete-single-order-form');
    if (singleDeleteForm) {
        singleDeleteForm.addEventListener('submit', async function(event) {
            event.preventDefault(); 
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = 'Deleting...';

            const url = this.action;
            const orderId = url.split('/').filter(Boolean).pop();

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken, 'X-Requested-With': 'XMLHttpRequest' },
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                closeModal(deleteConfirmModal);
                showDynamicMessage(data.message, 'success');
                removeCardsFromUI([orderId]);
            } catch (error) {
                closeModal(deleteConfirmModal); // âœ… ADD THIS LINE
            showDynamicMessage(`Error: ${error.message}`, 'error');
            } finally {
                 submitButton.disabled = false;
                 submitButton.textContent = originalButtonText;
            }
        });
    }
    
    // Helper function to populate and open the single delete modal
    function openDeleteConfirmModal(data) {
       if (!deleteConfirmModal) { console.error("Cannot open delete confirmation modal - not found."); return; }
       const form = deleteConfirmModal.querySelector('#delete-single-order-form');
       form.action = `/dashboard/student/delete-order/${data.orderId}/`; // Use data.orderId
       const confirmNameEl = deleteConfirmModal.querySelector('#delete-confirm-product-name');
       confirmNameEl.textContent = data.size ? `${data.name} - ${data.size}` : data.name; 
       openModal(deleteConfirmModal);
    }

    updateBatchActionBar(); // Initial check
});
</script>
{% endblock %}