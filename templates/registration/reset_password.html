{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - CIT Shop</title>
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Style for our new AJAX messages */
        #form-messages ul {
            padding-left: 20px;
            margin: 0;
        }
        .success-message {
            color: #155724;
            background-color: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-side">
            <div class="form-container">
                <h1>Reset Password</h1>
                <p class="welcome-text">Enter your new password</p>
                
                <div id="form-messages"></div>
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="{% if message.tags == 'error' %}error-message{% else %}success-message{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="post" id="reset-form">
                    {% csrf_token %}
                    
                    <div class="form-group">
                        <label for="password1">New Password</label>
                        <input type="password" 
                               name="password1" 
                               id="password1" 
                               placeholder="Minimum 8 characters, 1 upper, 1 lower, 1 num, 1 special"
                               required>
                    </div>

                    <div class="form-group">
                        <label for="password2">Confirm New Password</label>
                        <input type="password" 
                               name="password2" 
                               id="password2" 
                               placeholder="Re-enter password"
                               required>
                    </div>

                    <button type="submit" class="btn-login" id="submit-button">RESET PASSWORD</button>
                </form>
            </div>
        </div>
        
        <div class="right-side">
            <div class="logo-box">
                <h1>CIT</h1>
                <h2>WILDCATS</h2>
                <div class="logo-icon"><i class="fa-solid fa-cat"></i></div>
            </div>
            <p class="tagline">Almost Done!</p>
            <p class="tagline">Create New Password</p>
            <p class="tagline">Pride of Cebu</p>
            </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const resetForm = document.getElementById('reset-form');
    const submitButton = document.getElementById('submit-button');
    const messagesContainer = document.getElementById('form-messages');

    // Helper function to show messages
    function showFormMessage(messages, isError = false) {
        messagesContainer.innerHTML = ''; // Clear old messages
        const messageDiv = document.createElement('div');
        messageDiv.className = isError ? 'error-message' : 'success-message';
        
        if (Array.isArray(messages)) {
            const ul = document.createElement('ul');
            messages.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = msg;
                ul.appendChild(li);
            });
            messageDiv.appendChild(ul);
        } else {
            messageDiv.textContent = messages;
        }
        messagesContainer.appendChild(messageDiv);
    }

    resetForm.addEventListener('submit', async (event) => {
        event.preventDefault(); // Stop normal form submission
        
        // Show loading state
        submitButton.disabled = true;
        submitButton.textContent = 'RESETTING...';
        messagesContainer.innerHTML = ''; // Clear previous errors

        const formData = new FormData(resetForm);
        const csrfToken = formData.get('csrfmiddlewaretoken');

        try {
            const response = await fetch(window.location.href, { // Post to the same URL
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            const data = await response.json();

            if (!response.ok) {
                // Handle 4xx/5xx errors (e.g., validation errors)
                // data.errors will be our list of validation messages
                throw new Error(data.errors ? data.errors.join('\n') : 'An unknown error occurred.');
            }

            // --- Handle Success ---
            if (data.success && data.redirect_url) {
                // The backend adds the message to the session, so no need to show it here.
                // Just redirect.
                window.location.href = data.redirect_url;
            }

        } catch (error) {
            // --- Handle Fetch/Validation Errors ---
            // Split errors by newline in case we joined them
            const errorList = error.message.split('\n');
            showFormMessage(errorList, true);
        } finally {
            // --- Reset Button ---
            submitButton.disabled = false;
            submitButton.textContent = 'RESET PASSWORD';
        }
    });
});
</script>
</body>
</html>